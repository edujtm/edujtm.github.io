{"componentChunkName":"component---src-templates-blog-js","path":"/blog/opencv-motion-detector","result":{"data":{"markdownRemark":{"id":"3cc9d66e-b075-542b-b93d-691ddd1985a6","frontmatter":{"title":"Detecting motion by manipulating image histograms on OpenCV","date":"24/10/2020"},"html":"<p>Suppose your boss tells you to implement a motion detector for his company, but you've never done this before and he gave you a really short deadline.\nAt first sight it seems that detecting motion in a picture might be a challenging task: how do we define what is a movement from a group of pixels\nif there's no defined relationship between them? If we go with the route of processing individual pixels to check if they've changed their position, that for sure will lead to some headaches.</p>\n<p>You then go check the internet for solutions and you find that current image procesing techniques allows for various methods of detecting motion in a video stream using segmentation techniques to\nseparate foreground objects from the background. These techniques often employ complex mathematical tricks that might go over the\nhead of the uninitiated, so we would like to find a simpler implementation that's not as robust but still does the job.</p>\n<p>Luckily there's a simpler form of doing it, that requires thinking about properties of the image in its entirety rather than its components. If we assume that any moving object will introduce new pixels into the image, either from the background behind the object or from the object itself, we can use the change in the quantity of pixel intensities over the whole image to determine if there's movement. A representation of the frequency of data in a sample is given by an histogram. Since working with histogram is very useful in computer vision, OpenCV offers a set of tools for creating and manipulating this kind of data representation.</p>\n<h2 id=\"understanding-histograms-in-opencv\" style=\"position:relative;\"><a href=\"#understanding-histograms-in-opencv\" aria-label=\"understanding histograms in opencv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Understanding histograms in OpenCV</h2>\n<p>Before we implement our motion detector, we first need to understand what is a histogram and how to work with them in OpenCV. When it comes to images, the histogram is a representation of the frequencies of intensities from all the pixels. This is done by separating the full value range of intensities into partitions and counting every pixel whose intensity falls within each partition. In the simplest case where the number of partitions (bins) is the same as the quantity of values in the range, we get an image histogram like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.42553191489361%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA30lEQVQoz32R2Q6DMAwE+f9PRQJx5CKXm3HrKupDLa02GGeyhCXnLLVW2bZN9n2X1po8z6M9qveuHmOUEIJY8X5dVzmO4zuHFgZLKQoCzhogmgcpesz9qyWlpBBOtLS4Aeeib3A76FeaEIiBgOPIUlsyPlk3fg5gnXNTL6WNmQFkCBgb5qSWkL7pfYf90+9jtktIVb0MfYGADGZANBfAlKJufkaqOEDI+fFFhTAT0ADzTzGg3RnAGIPCQmxyu6LufFUY0FqbLLZ5Tmk+A3Hu2/sg1+1V5+nkuvyA8+w0yAtTxXYxmO+13wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Histogram of a 5 by 5 image\"\n        title=\"Histogram of a 5 by 5 image\"\n        src=\"/static/f9155045736f3768e65aa1888839aed3/1d69c/image-histogram.png\"\n        srcset=\"/static/f9155045736f3768e65aa1888839aed3/4dcb9/image-histogram.png 188w,\n/static/f9155045736f3768e65aa1888839aed3/5ff7e/image-histogram.png 375w,\n/static/f9155045736f3768e65aa1888839aed3/1d69c/image-histogram.png 750w,\n/static/f9155045736f3768e65aa1888839aed3/78797/image-histogram.png 1125w,\n/static/f9155045736f3768e65aa1888839aed3/aa440/image-histogram.png 1500w,\n/static/f9155045736f3768e65aa1888839aed3/b8bf8/image-histogram.png 1728w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>But the number of bins doesn't need to be the same as the size of the intensity range and the size of each partition might not be uniform. In the previous image we could group the values in 5 bins instead of 10, which would give the ranges: [0, 2), [2, 4), [4, 6),  [6, 8), [8, 10).</p>\n<p>The function OpenCV gives to get the histogram from an image is <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#ga4b2b5fd75503ff9e6844cc4dcdaed35d\">cv::calcHist()</a> and it has a fairly complicated API due to it being a generic function that tries to adapt itself to one or multiple images of varying channels with uniform or non-uniform intensity bins. We will only use it for a single image, so we need to adapt this image to what is expected by the API (i.e. a vector of images).</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">cv<span class=\"token operator\">::</span><span class=\"token function\">calcHist</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">const</span> cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">*</span> images<span class=\"token punctuation\">,</span>      <span class=\"token comment\">// C-Style array of images</span>\n\t<span class=\"token keyword\">int</span> nimages<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// Number of images in images array</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> nchannels<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// The number of channels in each image</span>\n\tInputArray mask<span class=\"token punctuation\">,</span>            <span class=\"token comment\">// Which pixels are taken into consideration</span>\n\tOutputArray hist<span class=\"token punctuation\">,</span>           <span class=\"token comment\">// The output histogram for all images</span>\n\t<span class=\"token keyword\">int</span> dims<span class=\"token punctuation\">,</span>                   <span class=\"token comment\">// Then number of dimensions of the histogram</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> histSize<span class=\"token punctuation\">,</span>        <span class=\"token comment\">// The quantity of bins for each histogram</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> ranges<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// Defines the size of each bin</span>\n\t<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// Are the bins uniform? (same size)</span>\n\t<span class=\"token keyword\">bool</span> accumulate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>     <span class=\"token comment\">// if true, the histogram will not be cleared when allocated</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>Theres a lot to digest here, so let's go through the parameters one by one:</p>\n<ul>\n<li><strong>image</strong> - The array with the images whose histogram is going to be calculated. The images must be 8-bit integer or 32-bit floating point. All images must have the same dimensions, but varying the number of channels is allowed.</li>\n<li><strong>nimages</strong> - Number of images in the <strong>image</strong> array. Since C-style arrays don't carry information about its size, it's necessary to pass it through the API.</li>\n<li><strong>nchannels</strong> - The channels of interest in each image. The channels are numbered as if they were flattened into a single array of all image's channels, therefore if we're interested in the 1st and 2nd channel of the first image and the 2nd channel of the second image, we would need an vector <strong>nchannels</strong> = { 0, 1, 4 }. A nullptr can be passed if a single image with a single channel is going to be processed.</li>\n<li><strong>mask</strong> - A 8-bit mask that selects which pixels are going to be taken in consideration. Only pixels from the image whose corresponding pixel in the mask is non-zero will be counted. If we wish to count all pixels in the image, <code class=\"language-text\">cv::noArray()</code> can be passed.</li>\n<li><strong>hist</strong> - The output histograms for all images.</li>\n<li><strong>dims</strong> - The number of dimensions of the histogram. The function is able to deal with high-dimensional data in case we want to group it in high dimensional bins. For example, we might have an RGB image for which we want to see the frequency of values with a certain red and blue color, this would give us a 2 dimensional histogram where <code class=\"language-text\">hist.at&lt;float&gt;(i,j)</code> would give us the frequency of pixels with <strong>red intensity = i</strong> and <strong>blue intensity = j</strong>.</li>\n<li><strong>histSize</strong> - Defines the quantity of bins used in each dimension of the histogram.</li>\n<li><strong>ranges</strong> - The range of values of the histogram. This parameter is used to determine the range of data values that will fall within each bin. The interpretation of this value depends on the value of the <strong>uniform</strong> parameter: If the histogram is uniform, it's only necessary to define the minimum and maximum value of the range, which will be divided uniformly by the quantity of bins. If the histogram is not uniform, then it's necessary to define the ranges for all bins explicitly (i.e. it's necessary to specify an array with histSize[i] + 1 elements).</li>\n<li><strong>uniform</strong> - If the histogram is uniform, then all bins are of the same size.</li>\n<li><strong>accumulate</strong> - If the values already in <strong>hist</strong> are replaced or not during the operation. Setting accumulate to true allows to gather a histogram across different calls to <code class=\"language-text\">cv::calcHist()</code> given that the same variable is used for <strong>hist</strong>.</li>\n</ul>\n<p>Since the <strong>ranges</strong> parameter is fairly complex, it deserves a little bit more of an explanation. Let's see how we might specify ranges for the histogram example shown in a previous image which has a intensity range between [0,10).</p>\n<p>If we want our range to be uniform but with bin sizes of 2 elements, we can specify it as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>This would take the range from [0,10) and divide it uniformly into 5 bins.</p>\n<p>Let's say we want to separate the range into 4 non-uniform bins of ranges [0, 2), [2,5), [5, 8) and [8, 10). The parameters would have to be specified in this way instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Where we notice that the range for bin <em>i</em> is given by the values of <em>ranges[i]</em> and <em>ranges[i+1]</em> and we need to specify histSize[i] + 1 elements to define the range.</p>\n<p>If we have an image encoded in HSV color space where each channel has a different range. We would need to specify a separate array for each channel:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">360</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// range of data for hue channel</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// range of data for saturation channel</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// range of data for value channel</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>These parameters would result in a 3 dimensional histogram with the hue channel divided into 60 bins and the saturation and value are divided into 20 bins.</p>\n<p>It's important to understand that the <strong>images</strong> array is not meant to generate histogram for multiple images at once, it's only a channel selection mechanism: we can pass two single-channel grayscale images and select both of the channels using <strong>nchannels</strong>, but this won't generate two separate histograms, instead it'll generate a single 2-dimensional histogram where each bin is an element of the cartesian product of the first and second image bins.</p>\n<h2 id=\"using-histograms-in-image-processing-histogram-equalization\" style=\"position:relative;\"><a href=\"#using-histograms-in-image-processing-histogram-equalization\" aria-label=\"using histograms in image processing histogram equalization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using histograms in image processing: histogram equalization</h2>\n<p>Now that we've got an understanding of creating histograms in OpenCV, let's see how to use them in practice. One of the most simple effect we can achieve using histogram is improving image contrast with histogram equalization. This technique aims to remap pixel intensities in an image in such a way that the resulting histogram has a uniform distribution across the whole intensity range. This process is illustrated below:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.17021276595745%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAAy0lEQVQoz21Riw7EIAjz//91y3LqHAhyFvfwliNrJqGWgiHnbK01Q8QYbdu2O8f/AkJELKXkOc7rutqyLA4ick6otXrRL6ga8lnwHXpy/gX4AYec2Q7Sn8IsqmhyikAQOJkTRgQkn0iWsnSHs6M2qF2I+2gVq2D2KfLOVg7tkBt7EavSHcJBTGTEII4C8HdsuO2CXMXQW7U5wMF9TBlA2As/O/KFNxdHx/cKnh3OD9aMGY7rcCgyHuaCqriL4o3a+CbHM/fi184nYvsC9I0pAfJsIzQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"An histogram being equalized\"\n        title=\"An histogram being equalized\"\n        src=\"/static/8fd6c0cf7b82b97697cfb75496e8e97b/1d69c/histogram-equalization.png\"\n        srcset=\"/static/8fd6c0cf7b82b97697cfb75496e8e97b/4dcb9/histogram-equalization.png 188w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/5ff7e/histogram-equalization.png 375w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/1d69c/histogram-equalization.png 750w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/78797/histogram-equalization.png 1125w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/aa440/histogram-equalization.png 1500w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/2adcb/histogram-equalization.png 1984w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>If the histogram was continuous, the resulting equalization would lead to a perfectly uniform distribution, but since the histograms obtained from images are discrete, the equalization results in an approximation of the uniform distribution.</p>\n<p>The discrete histogram equalization is defined by the following equation:</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>k</mi></msub><mo>=</mo><mfrac><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow><mrow><mi>M</mi><mi>N</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>k</mi></munderover><mi>h</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy=\"false\">[</mo><mi>j</mi><mo stretchy=\"false\">]</mo><mspace width=\"1em\"/><mi>k</mi><mo>=</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>3</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi>L</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">  out_{k} = \\frac{L-1}{MN}\\sum_{j=0}^{k}hist[j] \\quad k = 0, 1, 2, 3, ... L - 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.2498900000000006em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8361130000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span>\n<p>Where a pixel with intensity <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> in the source image would be mapped to an intensity <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>k</mi></msub></mrow><annotation encoding=\"application/x-tex\">out_{k}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> are the image dimensions and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> is the maximum intensity value. Since the output might be a fractional value, the intensities are rounded to the nearest integer.</p>\n<p>By spreading pixel intensities across the whole intensity range, pixels are mapped in a way that the contrast between features in an image is enhanced. This could be used to recover details in a washed out image, for example.</p>\n<p>This operation is implemented by the <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#ga7e54091f0c937d49bf84152a16f76d6e\">cv::equalizeHist()</a> function in OpenCV. Let's see how we can use it to process a video stream.</p>\n<h3 id=\"obtaining-the-video-stream\" style=\"position:relative;\"><a href=\"#obtaining-the-video-stream\" aria-label=\"obtaining the video stream permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Obtaining the video stream</h3>\n<p>A video stream can be obtained using <a href=\"https://docs.opencv.org/4.4.0/d8/dfe/classcv_1_1VideoCapture.html\">cv::VideoCapture</a> class, it works for both recorded videos by specifying the path on the filesystem where it's stored and live camera feed by specifying the camera ID.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>VideoCapture cap<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        cap<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cap<span class=\"token punctuation\">.</span><span class=\"token function\">isOpened</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Couldn't open camera\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Defines the size of the frame to be captured</span>\n    cap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_WIDTH<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_HEIGHT<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// The requested width x height might not be available</span>\n    <span class=\"token keyword\">int</span> width <span class=\"token operator\">=</span> cap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_WIDTH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> cap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_HEIGHT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>We need to specify the width and height of the video stream, but not all sizes are supported, so we also need to query the property to see the actual selected values.</p>\n<h3 id=\"reading-frames\" style=\"position:relative;\"><a href=\"#reading-frames\" aria-label=\"reading frames permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reading frames</h3>\n<p>Now we need to read the frames from the video stream and apply the histogram equalization on each one.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* obtain the video stream */</span>\n\n    cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap <span class=\"token operator\">>></span> image<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            std<span class=\"token operator\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not read frame from video, possibly due to wrong screen dimensions.\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// --- histogram equalization ---</span>\n        <span class=\"token keyword\">auto</span> equalizedImage <span class=\"token operator\">=</span> <span class=\"token function\">equalize_rgb</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token keyword\">auto</span> equalizedLabImage <span class=\"token operator\">=</span> <span class=\"token function\">equalize_cie_lab</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"equalized rgb\"</span><span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"equalized cie lab\"</span><span class=\"token punctuation\">,</span> equalizedLabImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> ESCAPE_KEY<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Two different equalizations are being applied here, one directly in the RGB channels of the image and another that first changes the image from RGB to CIE Lab color space and then apply the equalization on the luminosity channel only.</p>\n<p>It's only necessary to do one equalization, we're doing two different equalizations here so that we can compare the effect of each one on the original image.</p>\n<h3 id=\"defining-the-equalization\" style=\"position:relative;\"><a href=\"#defining-the-equalization\" aria-label=\"defining the equalization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Defining the equalization</h3>\n<p>Equalizing the histogram of an RGB channel is done by equalizing each channel individually, this can generate unwanted visual artifacts in the image: Since the color information in the RGB image is only complete when the channels are combined, equalizing the channels separately might introduce new colors in the image due to the different remapping that happens on each channel. A correct equalization would have to remap the three channels identically.</p>\n<p>Since what we want is to raise the constrast of the image intensity rather than messing with its colors, we can change the representation to one where the intensity is expressed separately.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/*\n * Equalization done on individual RGB channels\n */</span>\ncv<span class=\"token operator\">::</span>Mat <span class=\"token function\">equalize_rgb</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> <span class=\"token function\">equalizedChannels</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span><span class=\"token function\">Mat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n    cv<span class=\"token operator\">::</span>Mat equalizedImage<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>equalizedChannels<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> equalizedImage<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\ncv<span class=\"token operator\">::</span>Mat <span class=\"token function\">equalize_cie_lab</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> result_planes<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat lab_image<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> lab_image<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>COLOR_RGB2Lab<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>lab_image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat equalizedLuminosity<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedLuminosity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    result_planes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        equalizedLuminosity<span class=\"token punctuation\">,</span>\n        planes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        planes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat equalizedLabImage<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>result_planes<span class=\"token punctuation\">,</span> equalizedLabImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>equalizedLabImage<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>COLOR_Lab2RGB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> equalizedImage<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* Obtain video stream*/</span>\n    <span class=\"token comment\">/* read video frames */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>The <a href=\"https://en.wikipedia.org/wiki/CIELAB_color_space\">CIE Lab color space</a> has a separate channel that represents light intensity of the pixel, we can then apply the equalization on this single channel and then convert the image back to RGB.</p>\n<p>With this, we can run our resulting binary and see the results:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./build/equal_hist ~/Videos/the-wacky-wabbit.mp4</code></pre></div>\n<br/>\n<p>With the no equalization video frame being:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8AGmVqmaTpnWdqoCjq6NyZLRsT7ZyVZhNRJNEP3d2g3uswK7BwbjHxbfLzKq/w560vJGuvXenxHGnx3StzABvnq53pq+UuLantqi8iGSsblK1c1Oxdl2kY0+Cam+FssG0xMS2xcCwvLmtwsWiusGHrbx2qcJ2qcR1rsoAfZGilH2ThoWUjp6T0rFtrH5ZpGNOu31frHJXlGBWgJOeocjOrpyapYmHpMTIjK+5fqy/fa7BfK/Ff7PJALdggLdBda1adbaWdNGtbrePYZ5oUbuCV658XZVaRqSJgK/Iw66CdJpxboCsun+tuoGuvYWxwYa2xI67ywCqSXOBR22MVWi4WHLDZnnTqHTKpGbLoF6uf1qXXEqWdm2piHy7dFmqcGSZt72Zwsyawcmaw8iexsujydAAd2VqZUJjdzxYrUd6ViRDrV9v0aB5z61uwJVosoNbn2NXqVxRuG1VuXRapJ+Loq+VpaZ+o6+ln77BoMDBAIx6cUsZRG84T4RLYUg5QGktT8ybfsR/hMyBfsmFdLVVfqpKV7GDW5WVVp2bTq2US6SrVq+kha6lpb67rwCzo4tfVEiEb0yyn2J7aEmQUWy0dnqIOm2WWmCTW2GRRnHIkW3GsHNnjEyDnVGdqVmUs1q0t4DCrqDCuacA0MKgqJZrinNHnJBZfW9GjjxhuGl/wqx2fnFFtJpizrBy17x00bh3e5NPa4hCnrtjnbVhrqdwvoFuwqmTAMSwhMeyeopxSpOFVl9ZOmhYQY50VJaLVZuVXtSvc9Gzd9fEftS/d6emaqSgbLKOYLaKZcGec82bbMOYcgC0o3Orl2eEZkhvXz55b0mLek55ZTyif0/axH3XwH3Fk2raxIXbzILNvHzZwIjMjWzNgWbYwYTfzYrYwX8A4MiKzbx+1syMfHBLRT0haWA7iGdDum9KtXNSx5pizKdwwpVnvqBru7t1cWxDSDoyTF42oKdq5M2S2MCKANTGjsu+is67hK6QYyEZEBkeE1AsHGkaF4IzMaRUI6NNL20lHYI6KlpSNjAwHQAUDwo9J05VOLJ8WItbQgCSbE5wOC5kHxh2LCVjJiQhCAkbCgdzJSBpGheYQiB9IhdyHSAzEQkxGxY1GhMBEgsSOyosKBptGwlSDghsIK+YPQ1MgwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with no equalization\"\n        title=\"The Wacky Wabbit intro with no equalization\"\n        src=\"/static/446b9c750178e61ffe645c7fc1b4ec8a/1d69c/normal-wabbit.png\"\n        srcset=\"/static/446b9c750178e61ffe645c7fc1b4ec8a/4dcb9/normal-wabbit.png 188w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/5ff7e/normal-wabbit.png 375w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/1d69c/normal-wabbit.png 750w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/00d43/normal-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>We have this resulting RGB equalization:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8ACZ2wiRzvTmFwUiQwoFUW6BOO6VVQWQxKloqIjZYhz6Z3pTW5Kvo6qjx9ovP5nCt2Vif2TWL6C6M8DGc+AAsgMY1jMhjt8+Ftb2xa1uPUT6jVT+bWU98RThETGlMqOCg3+qm4+KXztmR1+p3v+NLm9g2j+M2keozofUAQXS6ZmCmT2ilXoCj1qBsi2VIfkM1sWFTjVVFXkFEQ3WufNv1k6OqgH2OfdLrU6PTQJndP53iPaHrQKz1AKRDjaYoepM9e6R/d9eebaR6VnBKO69lRZRhUWE5K3+AgZfa5JNqdGxTaT6Z0kGb00Kh2Uan4Emz61TD9gCTMXpeNm5oQGakP3a7S4HZnHbJkWDKhVKSZEplOy9hY2SKdX2wU0uLVFprvtxq0/Fr0+5s2PBx4fZ77fwAUk91NzZgUixSki6CNxQ9oEZ105V/1J9tt39jm2lMcUVFhz88qFBCqFlLfpaVerGkgaaDfrW6dMriddDjAG1hfxQNM0ssSWI/XScxNUkXTMmTh8Bqk81qh8dudqI5iI0qR5hwTnKJUXSPQJCEPn+qSpSXjZKTvrHFxgCqlqA9P0dzaU20pmdsY0lzN3KgX4FYJmx6SF50Sl9nOHHHhGu+q3Q8gUVVk0ZunEtgrk2fuIi7obm6v78A0Mm7opd3e21JlZxfbWZHcyJipVeHw7x+aWZGrJJg1bF058B407t6ToZHOnk3bbpXcrlak6l0s2Juuq+hAMq/mdTMi3hoS4iNXE1SOlRXQ35zVouPXJOjZdiuddm2fuTeid3QfJKkbJajdJqFW6Z2X7uQeNWaa72KcgC7uoOnm3FvWkhYWj5wd0+EfVJtWzyabEns4Ibo1obDgGXr3ZXt75DPzIXm05jKhXHLa2Dl0JH28J3p1o0A8+CbzMKI3uaed3RRLDAcV1g4e1pAqFo+olxGyJdj0KFzw4dqtZ5toL11WWJAPiUqK0AjmbBw9+Gn4sWZAOPopNPcntHUlaubbQ4PDA0XEDYnGzISEUkgJIM3F4U6JDwYFVMoHkFKNSApGwALCAAkFjJEL5h/YG1ZSQB6c1Y/MiorGBQ+Hxs4GBYKAwYHBQRJFxMzEA5xKxVKFQ02EhMWCQYfDw4fEAsACwgIJhwMFhAwCwEpBwME0Y9csW+2RwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with RGB equalization\"\n        title=\"The Wacky Wabbit intro with RGB equalization\"\n        src=\"/static/e9c91a266e9c8fe3caf3f9348b389125/1d69c/rgb-wabbit.png\"\n        srcset=\"/static/e9c91a266e9c8fe3caf3f9348b389125/4dcb9/rgb-wabbit.png 188w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/5ff7e/rgb-wabbit.png 375w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/1d69c/rgb-wabbit.png 750w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/00d43/rgb-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>In this case, the RGB equalization looks good, but its still noticeable that it introduced pink outlines in the mountains.\nFinally the resulting CIE Lab equalization:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8AEZxgkFtfVuCjWyOlXlNOIhFIIxNJWwnD2khDk9RWGybrtDi4+T08uf7/cXa36K4woqntmGQrF+UsnGqyQBPfIpdi5OXuripuKuVYzqBSCSKTCKIUTB5PCFYQ0KArLrc7e3f7+nM2dfP5OezzNN7obBlla5nmbNzrcgAW259bllsYWFua3pus5RNhFkvdjoblFk1gkwqZzgoXXB5wOjttqaik3t3vt/jhamzc6Czdqa5eqzChLjQAIw6VokXR4IzS5V2UrWRUZVwPnJBJJJdKodZNmQuE5d+cs3l4I5mVXFLRG+cqnOgrHuptoSxv4+/zqPR4QCCJktjLFBrNkiOMkiaQU+8klyrhkWmfTWGWjFoMRp6XVGPcmCNSiiBTDmox8y23+m13eW54+nE7fLP9/wAW0tPUC5NWiA7gh5PPQ0qiD5Lu4xjt5ZUoHdHi18zcjwpfDYgjEglj08tl5R9orGVnJ9zq7iutNPWutvcAG1bUzMBK1ghN2w0SjwtNEoQMLuNbaViZapkXKZlUIktUnofIZBmNHp7PHx7K4pzJ4yUPJqQcJyVlM7MwACklHxJPTF6Z0SzoWNwXj9rLkeRVldiFUZ5P0N3QUVzKlSwe1S1oGFRdDZngDN+ijZ7mT6qrXW3pJXMwrAA18imp5Rqf2k9opZgcWM6ZhY5mEtfy7V/b2I4pItRx6lr07hwybFuYHc0TWklhKBFiqFMo51lll1Gxa6WAM++kdzIj35lP5aKXFZSMmRUPoZuTZaKVqOeZ8mmaM2vcujVkNvGfZuaX6Cdapt7R5huRK2LX8GTYa2EXADEuomsl2dzVzhmWDV9d1GJek1sWDCHZjLt2I/mz4upekzu2Jj255zWxYTlz5W7gFmrZD7gzI737Kvj0Y8A8Nqayrh66OGifnNPNi4RXFUudVgxmVIiklUpu5BXv5piroJTtJdgs7RsYl41MiQZKTgNoapt8Nuh0r2FAO/lsOPZpd/Pl7KYahgRBhIYDEgnFlkOBmIZDHguAYMzEFgUBmQiCFBILCgoFgAMCAAiDjtAIq17VoNWPACTdFdlMCFZFQphGw5LFAgcAwIXBwJaEQFWCwB0JABkDwFdDQMpBwAiDQYnDgMADQcBJhQcFAlTBgBDBQAx9oCakQRmkwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with RGB equalization\"\n        title=\"The Wacky Wabbit intro with RGB equalization\"\n        src=\"/static/190555c8f5ae762b83ce5b5dde99de01/1d69c/cielab-wabbit.png\"\n        srcset=\"/static/190555c8f5ae762b83ce5b5dde99de01/4dcb9/cielab-wabbit.png 188w,\n/static/190555c8f5ae762b83ce5b5dde99de01/5ff7e/cielab-wabbit.png 375w,\n/static/190555c8f5ae762b83ce5b5dde99de01/1d69c/cielab-wabbit.png 750w,\n/static/190555c8f5ae762b83ce5b5dde99de01/00d43/cielab-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>We notice that the equalization made the original image darker and that we can see the constrast in the cactuses and clouds much better.</p>\n<h2 id=\"implementing-the-motion-detector\" style=\"position:relative;\"><a href=\"#implementing-the-motion-detector\" aria-label=\"implementing the motion detector permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementing the motion detector</h2>\n<p>Well, after talking about histograms for long while, we can finally start implementing our motion detector. The idea behind implementing a moviment detector using histograms involves comparing the histogram between subsequent frames and checking if the object motion introduced changes in the frequency of pixel intensities.</p>\n<p>Our movement detector will show an text alarm on screen in case it detects any moving object so we can see if it's working correctly.</p>\n<p>To implement the histogram comparison, we need to store both the current and the previous frame so that we're able to compare them. I decided to use an std::deque for it because I thought the problem mapped well to a moving window, but there might be a simpler implementation that only stores the previous frame.</p>\n<p>Based on this, we arrive on the following implementation:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/**\n * Calculates a similarity score between two subsequent histograms.\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HistogramSimilarity</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>deque<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> window <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> _score <span class=\"token operator\">=</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// 1.0 is a perfect histogram match</span>\n\n    <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat current_histogram<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// If there's a single frame, we store the current one</span>\n            <span class=\"token comment\">// and calculate the similarity score.</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">auto</span> previous <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">,</span> current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// If there's already 2 frames we discard the </span>\n            <span class=\"token comment\">// oldest histogram to make room for the new one</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                window<span class=\"token punctuation\">.</span><span class=\"token function\">pop_back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">auto</span> previous <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">,</span> current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// If there's no frame stored, we can't calculate the score yet</span>\n            window<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">float</span> <span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat hist1<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>Mat hist2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> cv<span class=\"token operator\">::</span><span class=\"token function\">compareHist</span><span class=\"token punctuation\">(</span>hist1<span class=\"token punctuation\">,</span> hist2<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>HISTCMP_CORREL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>We have a single push method that will receive the frames and calculate the scores on demand. There are three possible states for our moving window: </p>\n<ul>\n<li>the window is empty, meaning that no frames we're consumed yet. We can't calculate the similarity, so we just store the frame and wait for the next one.</li>\n<li>the window has a single frame. In this case we calculate the similarity and store the frame for the next operations.</li>\n<li>the window has two frames. In this case, we discard the oldest frame, calculate the new score and store the current frame.</li>\n</ul>\n<p>The score is implemented by means of <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#gaf4190090efa5c47cb367cf97a9a519bd\">cv::compareHist()</a> using the <code class=\"language-text\">cv::HISTCOMP_CORREL</code> comparison method, which just calculates the <a href=\"https://en.wikipedia.org/wiki/Correlation_and_dependence\">statistical correlation</a> between the histograms. Using this comparison method, the absence of movement would be represented by a score equal to 1.0, while a movement would tend to push the score towards -1.0 depending on how big of a change happened in the image.</p>\n<p>With this we have a score that allows us to implement the motion detector by checking if the score is greather than a threshold:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/**\n * Detects motion based on the similarity between\n * subsequent histograms of an image stream (camera feed/video).\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MotionDetector</span> <span class=\"token punctuation\">{</span>\n    HistogramSimilarity similarity<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> threshold<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_qnt<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_count<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n        <span class=\"token function\">MotionDetector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> thres<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_quantity<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n            similarity <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            threshold <span class=\"token punctuation\">{</span> thres <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            alarm_frame_qnt <span class=\"token punctuation\">{</span> alarm_frame_quantity <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            alarm_frame_count <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat histogram<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                alarm_frame_count<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            similarity<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">motion_detected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                alarm_frame_count <span class=\"token operator\">=</span> alarm_frame_qnt<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> similarity<span class=\"token punctuation\">.</span><span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">bool</span> <span class=\"token function\">motion_detected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> similarity<span class=\"token punctuation\">.</span><span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> threshold<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">alarm_counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> alarm_frame_count<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">bool</span> <span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> alarm_frame_count <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>The motion detector delegates the frames to the <code class=\"language-text\">HistogramSimilarity</code> class and checks if the resulting score is greather than the threshold. If we try to show the alarm on screen, it'll get erased as soon as we draw the next frame, which happens so quickly that we might not even see it happening. So we set a frame counter that will define for how many frames the alarm text will be shown.</p>\n<p>Finally, we can put this into practice by opening a video and reading its contents. We can obtain the video stream in the same way we did for the <a href=\"#obtaining-the-video-stream\">equalization example</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string file_path<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_width<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_height<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span> threshold<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_qnt_frame<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nConfig <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* parse cli arguments */</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* obtain video stream */</span>\n\n    <span class=\"token comment\">// ----- Configuring the histogram -----</span>\n\n    <span class=\"token comment\">// Histogram for each of the image channels</span>\n    cv<span class=\"token operator\">::</span>Mat histR<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Quantity of bins where pixel intensities will be grouped</span>\n    <span class=\"token keyword\">int</span> nbins <span class=\"token operator\">=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// The maximum range of pixels of the histogram</span>\n    <span class=\"token keyword\">float</span> range<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>histrange <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> range <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Are histogram bins uniform?</span>\n    <span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Replace histograms when counting new images?</span>\n    <span class=\"token keyword\">bool</span> accumulate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Holds the separate BGR channels (i.e. planes[0] is red channel)</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat resized_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point screen_size <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>screen_width<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_height <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    MotionDetector <span class=\"token function\">detector</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>threshold<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>alarm_qnt_frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap <span class=\"token operator\">>></span> image<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            std<span class=\"token operator\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not read frame from video, possibly due to wrong screen dimensions.\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">,</span> screen_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Splits the individual channels of an image</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>resized_image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">auto</span> blue_channel <span class=\"token operator\">=</span> planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Gets the histogram for the blue channel</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">calcHist</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span>blue_channel<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">noArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            histB<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>nbins<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>histrange<span class=\"token punctuation\">,</span>\n            uniform<span class=\"token punctuation\">,</span> \n            accumulate\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// We give the histogram to the detector</span>\n        detector<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>histB<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// If the alarm is active, writes a message on screen</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>detector<span class=\"token punctuation\">.</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            cv<span class=\"token operator\">::</span>Point2i top_left <span class=\"token punctuation\">{</span> resized_image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">putText</span><span class=\"token punctuation\">(</span>\n                resized_image<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Motion Detected\"</span><span class=\"token punctuation\">,</span>\n                top_left<span class=\"token punctuation\">,</span>\n                cv<span class=\"token operator\">::</span>FONT_HERSHEY_PLAIN<span class=\"token punctuation\">,</span>\n                <span class=\"token number\">1.2</span><span class=\"token punctuation\">,</span>\n                <span class=\"token function\">CV_RGB</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">}</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> ESCAPE_KEY<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>I've tested this implementation in this <a href=\"https://www.pexels.com/video/a-railway-under-a-flyover-3250590/\">video from pexels</a> which shows a train moving under a bridge. When choosing a good threshold value, it managed to detect the train moving fairly well.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./build/apps/motion_detector -i ~/Videos/train-bridge.mp4  --width <span class=\"token number\">480</span> --height <span class=\"token number\">320</span> -t <span class=\"token number\">0.9972</span></code></pre></div>\n<br/>\n<p>Some examples of the motion detector can be seen in the following images:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 480px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADIUlEQVQozw2MXWgbBQCA71FGVexas1zTtEmaXJrc/yV3vdx/7/J3l+Ty2ybtpe0lqfZnSTNwnQwG+8Ot/qBuDNlYBR/UPsgeCg7BB0H20EdhbGygTNh0KGywzTF0PzFP3/fyfYCCO2OTb8vIAQU9wEJDcniI9Q9y0DDjGdi5+Mmj+3e782ll8k0eGlw10TMHNRVzKSioEaNTgWEgToxIYUeCGJnlx1IkqGHOODqshB1R92tfnOz+9+DukSWD8+6bV/wftRNF3qeiDmFyMEGA/QWQjLjj+EiZdS+I4ILo6osRcekkKPj2nT1sv3r+zzs5Rkf3f7Ci1hRIgN7gAwNlFVstixoGAirhThGuK9sff//1+SOWsiCMZrFBM+LMkkP1BHrvzu0ZKdgt4nXFJ0OvL+fZr86fuvfr9as7l7NRNyAhoJ2hnzz8u9frPX384JdrP3y59d5GKTrHu7jAwPaFDw8tpS1l/PDi9E9XLjz580bv2f1/H/72+/WfV4oMwAbe+ux4p1++fP6013vR54tnjx/9dee7y1sl2W8XhUZRErDRvR+//ePWtas7l27v7d7a2725t3uiXQJE2LnZzHxz8ei5M+9uf77x6XHrWMe8tLV27tjyWlXcbCmtEmWqoaKBy0JU1zirEm9U1W4j2a5xgDE1YefJWR2a0SdrOtIsYWtz+MY8sj4bblWwth1s1oLFVNCaGWdp0OMFvT5nYALEwmMZMQSYQvBU2zjZTpzYkE53pdMd7miL2lzCO3W4WYHsqq+W91Sz3vmydybn04RxDHeMju93OIcIeAyoaGTHSi8XYo18tG6Qlo7PJYmSHMoIEwYfSHOQRnv1mF+JejjSw5N+CvaGAu4Q5MFhL1CeJq3sdEljCwqTFSmdJ9MxPM5gcRrVoogaReUIIlKwRCEyjSs0ITOkSBMCQwg0AVRUzDbYRoa1DcZKRqrTVEnCTB4xOaQvOQ42+XBBQHM8kuPh9BScZtEMT6Y4Ks1RwEohdnYl8/5C8lBNPViWVvPcshlr5mJ2JtafLqXoxQRpJ6nFVKSejFgpppkV1gtCK8uuV+T/AZKSAsXMvnoQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image of a bridge with a railroad underneath\"\n        title=\"Image of a bridge with a railroad underneath\"\n        src=\"/static/aa90b1fa4d7825a0f1c0165584cb1a42/e85cb/no-detection.png\"\n        srcset=\"/static/aa90b1fa4d7825a0f1c0165584cb1a42/4dcb9/no-detection.png 188w,\n/static/aa90b1fa4d7825a0f1c0165584cb1a42/5ff7e/no-detection.png 375w,\n/static/aa90b1fa4d7825a0f1c0165584cb1a42/e85cb/no-detection.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>The detector is able to see the train arriving:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 480px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADIUlEQVQozw3NX0wbdQDA8YtxmzNx9Fp6pdyf3t/eXX+9X3u9a6/XFgrt0ZaWtZTyXzZmFxKqI4AvojxsYQsZL/uTKSaO6ZIZjX+W+Wjc5gObQZYs/iX6xl6mbyQaZbjBTpLP8/eLJPzuo6GWmuZJCS6dRBMsquGvhIkm3nlgopb/eX115eJZnW6C+JG44Jp7TR/NSZB2QsoByCbECjaXNXc1hlcNIqN4YrxLYxyqDxVdBxsDXY9++m5p7nXoPaQz6PRw+FghEPI5Vdrh97wktBxGPl1e+HDpzXpOLipoQXFmAWYKmMm7YOvLA53w78cb85PDovOFiXJwvBvs/yXsAPQ5aoXkxYW3kP+e/GPb9h+bv32xcmF6KNMTxpLM4ZTf2Saicd618eB2vS/brWJjlhjwHEwrxOzJ/s+vL6/fu/Pr93eQ3Wfbz3ef2PbefmJn+68f1m6/vzh7oqAUQs0i9uLi/BuzJys5FRvMgOWFxsO7n/35+9qjX+7/eP/r9W+/Qmx71957au/tPH/2r20/te2t3Z3NrcdrH195Ox3Cyx1wuJgQWo98cuXMxurNG8vn791aWb117e7Nq998+QHy0aV33jt36t3FyaX58ctnJ07PVE4d71yaG12YHuy34ImK1peVUiqVSQhRFZhRWLSMat441mse740jpSRb7RAsk+w0KMtgjqbZmsW9WmCHuuhyhzBS9tWKVDrmK1peBaAeD0pSXjfmIryoyLiRuXpmasRoDOlTY5GZUXVqRGkMSPUyP9rN9mapSr7VSrdkE625tDeb8uQ7Aooe5SRZkmUxEEAm+9pmxrKN/li9oo73hMZLoJLiepJ0MUXlTDJjEO2aNxvFU6pXVzz5mGRSlCHyMVmMSn6k1B6tWslOHRiAj0psDHCaxIY4KsRTQY6CPA1YSqaJAE1INCn6cBJrdqNoM4q6UQdSSsCSqRTioCsqZzQprYptIX8SCknI70sEORNwZpCLA9YArC4zEYkOSwwUWeBnkXbI77Mi/nbIpoKsGaRVnojwuMbjSYWJiWSYx3XZZwQYXSQjfkLytcgMHhEZwDP/A2KW7gn9/1adAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image of the bridge with the train arriving at the railroad\"\n        title=\"Image of the bridge with the train arriving at the railroad\"\n        src=\"/static/4e17e3a054eb779fba34412cfde0727a/e85cb/train-arriving.png\"\n        srcset=\"/static/4e17e3a054eb779fba34412cfde0727a/4dcb9/train-arriving.png 188w,\n/static/4e17e3a054eb779fba34412cfde0727a/5ff7e/train-arriving.png 375w,\n/static/4e17e3a054eb779fba34412cfde0727a/e85cb/train-arriving.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><em>Disclaimer: Images taken from <a href=\"https://www.pexels.com/video/a-railway-under-a-flyover-3250590/\">this video</a> by <a href=\"https://www.pexels.com/@alexander-bobrov-390088?utm_content=attributionCopyText&#x26;utm_medium=referral&#x26;utm_source=pexels\">Alexander Bobrov</a> on <a href=\"https://www.pexels.com/\">Pexels</a></em></p>\n<p>Since this detector is not robust, it might have spurious detections that are probably not acceptable when we're designing an alarm. On top of that, the detector is very sensible to the threshold specified, if we give a value that's too low, we might not catch any slow movement and small objects might not  trigger the alarm because they don't change the histogram too much. So this is far from a good motion detector, but it's a good example of thinking of images in terms of its histograms.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Sometimes it might be useful to think of an image in terms of its histogram, rather than an array of pixels. With the histogram in hands we could apply an operation on it to see the effects on the image or use it in combination with other techniques to achieve a desired effect. OpenCV offers several functions to generate and manipulate histograms from images, my hope is that this article is able to show how to use some of them in practice.</p>"}},"pageContext":{"slug":"opencv-motion-detector"}}}