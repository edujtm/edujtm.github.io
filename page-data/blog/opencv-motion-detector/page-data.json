{"componentChunkName":"component---src-templates-blog-js","path":"/blog/opencv-motion-detector","result":{"data":{"markdownRemark":{"id":"3cc9d66e-b075-542b-b93d-691ddd1985a6","frontmatter":{"title":"Detecting motion by manipulating image histograms on OpenCV","date":"24/10/2020"},"html":"<p>Suppose your boss tells you to implement a motion detector for his company, but you've never done this before and he gave you a really short deadline.\nAt first sight it seems that detecting motion in a picture might be a challenging task: how do we define what is a movement from a group of pixels\nif there's no defined relationship between them? If we go with the route of processing individual pixels to check if they've changed their position, that for sure will lead to some headaches.</p>\n<p>You then go check the internet for solutions and you find that current image procesing techniques allows for various methods of detecting motion in a video stream using segmentation techniques to\nseparate foreground objects from the background. These techniques often employ complex mathematical tricks that might go over the\nhead of the uninitiated, so we would like to find a simpler implementation that's not as robust but still does the job.</p>\n<p>Luckily there's a simpler form of doing it, that requires thinking about properties of the image in its entirety rather than its components. If we assume that any moving object will introduce new pixels into the image, either from the background behind the object or from the object itself, we can use the change in the quantity of pixels over the whole image to determine if there's movement.</p>\n<h2 id=\"understanding-histograms-in-opencv\" style=\"position:relative;\"><a href=\"#understanding-histograms-in-opencv\" aria-label=\"understanding histograms in opencv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Understanding histograms in OpenCV</h2>\n<p>Before we implement our motion detector, we first need to understand what is a histogram and how to work with them in OpenCV. When it comes to images, the histogram is a representation of the frequencies of intensities from all the pixels. This is done by separating the full value range of intensities into partitions and counting every pixel whose intensity falls within each partition. In the simplest case where the number of partitions (bins) is the same as the quantity of values in the range, we get an image histogram like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 750px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.42553191489361%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA30lEQVQoz32R2Q6DMAwE+f9PRQJx5CKXm3HrKupDLa02GGeyhCXnLLVW2bZN9n2X1po8z6M9qveuHmOUEIJY8X5dVzmO4zuHFgZLKQoCzhogmgcpesz9qyWlpBBOtLS4Aeeib3A76FeaEIiBgOPIUlsyPlk3fg5gnXNTL6WNmQFkCBgb5qSWkL7pfYf90+9jtktIVb0MfYGADGZANBfAlKJufkaqOEDI+fFFhTAT0ADzTzGg3RnAGIPCQmxyu6LufFUY0FqbLLZ5Tmk+A3Hu2/sg1+1V5+nkuvyA8+w0yAtTxXYxmO+13wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Histogram of a 5 by 5 image\"\n        title=\"Histogram of a 5 by 5 image\"\n        src=\"/static/3d09d4c3f19e8ee070cc331dd652d6b2/1d69c/image-histogram.png\"\n        srcset=\"/static/3d09d4c3f19e8ee070cc331dd652d6b2/4dcb9/image-histogram.png 188w,\n/static/3d09d4c3f19e8ee070cc331dd652d6b2/5ff7e/image-histogram.png 375w,\n/static/3d09d4c3f19e8ee070cc331dd652d6b2/1d69c/image-histogram.png 750w,\n/static/3d09d4c3f19e8ee070cc331dd652d6b2/78797/image-histogram.png 1125w,\n/static/3d09d4c3f19e8ee070cc331dd652d6b2/aa440/image-histogram.png 1500w,\n/static/3d09d4c3f19e8ee070cc331dd652d6b2/b8bf8/image-histogram.png 1728w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>But the number of bins doesn't need to be the same as the size of the intensity range and the size of each partition might not be uniform. In the previous image we could group the values in 5 bins instead of 10, which would give the ranges: [0, 2), [2, 4), [4, 6),  [6, 8), [8, 10).</p>\n<p>The function OpenCV gives to get the histogram from an image is <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#ga4b2b5fd75503ff9e6844cc4dcdaed35d\">cv::calcHist()</a> and it has a fairly complicated API due to it being a very generic function that tries to adapt to one or multiple images of varying channels with uniform or non-uniform intensity bins. We will only use it for a single image, so we need to adapt this image to what is expected by the API (i.e. a vector of images).</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">cv<span class=\"token operator\">::</span><span class=\"token function\">calcHist</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">const</span> cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">*</span> images<span class=\"token punctuation\">,</span>      <span class=\"token comment\">// C-Style array of images</span>\n\t<span class=\"token keyword\">int</span> nimages<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// Number of images in images array</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> nchannels<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// The number of channels in each image</span>\n\tInputArray mask<span class=\"token punctuation\">,</span>            <span class=\"token comment\">// Which pixels are taken into consideration</span>\n\tOutputArray hist<span class=\"token punctuation\">,</span>           <span class=\"token comment\">// The output histogram for all images</span>\n\t<span class=\"token keyword\">int</span> dims<span class=\"token punctuation\">,</span>                   <span class=\"token comment\">// Then number of dimensions of the histogram</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> histSize<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> ranges<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">bool</span> accumulate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>Theres a lot to digest here, so let's go through the parameters one by one:</p>\n<ul>\n<li><strong>image</strong> - The array with the images whose histogram is going to be calculated.</li>\n</ul>\n<h2 id=\"using-histograms-in-opencv\" style=\"position:relative;\"><a href=\"#using-histograms-in-opencv\" aria-label=\"using histograms in opencv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using histograms in OpenCV</h2>\n<h2 id=\"implementing-the-motion-detector\" style=\"position:relative;\"><a href=\"#implementing-the-motion-detector\" aria-label=\"implementing the motion detector permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementing the motion detector</h2>"}},"pageContext":{"slug":"opencv-motion-detector"}}}