{"componentChunkName":"component---src-templates-blog-js","path":"/blog/opencv-header-problems","result":{"data":{"markdownRemark":{"frontmatter":{"title":"A fix for g++ not being able to find OpenCV dependencies on Ubuntu 18.04","date":"14/03/2020"},"html":"<h2 id=\"the-issue\" style=\"position:relative;\"><a href=\"#the-issue\" aria-label=\"the issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Issue</h2>\n<p>Adding third-party code to a C++ application is well-known for being a headache, requiring the user to know about the steps of the\ncompilation process, the OS environment and the difference between the types of library (static vs dynamically linked). The issue is\nannoying enough that some reasonably big C++ libraries like <a href=\"https://github.com/catchorg/Catch2\">Catch2</a> and <a href=\"https://www.boost.org/\">Boost</a>\noffer header-only solutions to simplify getting the build process to work correctly.</p>\n<p>OpenCV is a big library with many dependencies, and as such, is not exempt from this complex configuration process. Luckily some experienced\nusers have made detailed tutorials of the installation process to help us, layman users, benefit from the library, such as <a href=\"https://www.learnopencv.com/install-opencv-3-4-4-on-ubuntu-18-04/\">this one</a> which I used to install it on my computer.</p>\n<p> I thought that after finishing the tutorial I would be able to run <code class=\"language-text\">g++</code> and be done with it, but that turned out not to be true, which lead me into\nmultiple hours of troubleshooting in order to find out if I had done anything wrong.</p>\n<p> <em>If you do not wish to read the explanation of the problems and just fix them quickly, I've made a <a href=\"#tldr\">TLDR</a></em></p>\n<h2 id=\"the-missing-steps\" style=\"position:relative;\"><a href=\"#the-missing-steps\" aria-label=\"the missing steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The missing steps</h2>\n<p>At the end of the tutorial, we are instructed to run the following command in order to compile our code with opencv:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>g++ <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span> my_sample_file.cpp -o my_sample_file</code></pre></div>\n<p><br>\nWith <code class=\"language-text\">&lt;OpenCV_Home_Dir&gt;/installation</code> being the directory where we are supposed to install the OpenCV library. I modified the directory in order to suit my\nfolder organization, so in my case the library was installed at the following location: </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$HOME/Code/local/OpenCV-3.4.4/</code></pre></div>\n<p><br>\nUnfortunately, after running this command I was getting a bunch of undefined references to OpenCV functions.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">hello_world.cpp:(.text+0x5f): undefined reference to &quot;cv::imread(cv::String const&amp;, int)&quot;\nhello_world.cpp:(.text+0xb3): undefined reference to &quot;cv::imshow(cv::String const&amp;, cv::_InputArray const&amp;)&quot;\nhello_world.cpp:(.text+0xdb): undefined reference to &quot;cv::waitKey(int)&quot;</code></pre></div>\n<p><br>\nTo understand why this message is happening, let's first look at the pkg-config output.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>pkg-config --cflags --libs <span class=\"token environment constant\">$HOME</span>/Code/local/OpenCV-3.4.4/lib/pkgconfig/opencv.pc</code></pre></div>\n<p><br>\nWhich outputs:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-I/home/edujtm/Code/local/OpenCV-3.4.4/include/opencv -I/home/edujtm/Code/local/OpenCV-3.4.4/include -L/home/edujtm/Code/local/OpenCV-3.4.4/lib \n-lopencv_stitching -lopencv_superres -lopencv_videostab -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv \n-lopencv_dnn_objdetect -lopencv_dpm -lopencv_highgui -lopencv_videoio -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs \n-lopencv_img_hash -lopencv_line_descriptor -lopencv_optflow -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo \n-lopencv_structured_light -lopencv_phase_unwrapping -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot \n-lopencv_xfeatures2d -lopencv_shape -lopencv_video -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_imgcodecs \n-lopencv_features2d -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core</code></pre></div>\n<p><br>\nThis is the huge list of OpenCV modules that you need to specify so that the linker is able to find the pre-compiled binaries from OpenCV. You don't actually need to specify all of them, only the ones you're using, but pkg-config will add everything so that you won't have problems when using different modules.</p>\n<p>So essentially the error message is happening because the linker is not being able to find the binaries with the implementation of OpenCV functions, even though they are being specified in the command line.</p>\n<p>What surprised me was that the order in which you declared the libraries to be linked is important to the linking process. As explained briefly by <a href=\"https://stackoverflow.com/questions/31634757/how-to-correct-undefined-reference-error-in-compiling-opencv/31635489#31635489\">this comment by Ivan Aksamentov</a>:</p>\n<blockquote>\n<p>In short, the rule \"libraries come after objects that use them\" is enforced by many GCC distributions to link shared libs only as they are needed. In your case object file facerec<em>eigenfaces.o, being produced from source file facerec</em>eigenfaces.cpp, depends on OpenCV libs (exact list is given by a pkg-config command), and thus libs should go after that file. You could also notice very same pattern in pkg-config output: for example, X11, pthreads and other Linux system dependencies go after dependent OpenCV libs.</p>\n</blockquote>\n<p>To put it briefly: if you source code depends on an linked file, it should come before the specified linked file. Following this, the correct way to call the command is by placing the pkg-config after the files, like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>g++ my_sample_file.cpp -o my_sample_file <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span></code></pre></div>\n<p><br>\nAfter this was fixed, the files were compiling just fine. But now, the following error was happening at runtime:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./hello_world: error while loading shared libraries: libopencv_highgui.so.3.4: cannot open shared object file: No such file or directory</code></pre></div>\n<p><br>\nWell, that's progress, but we are not there yet. We moved from a linker issue to a shared library issue. The name shared comes from the fact that a single binary of this program can be used by multiple other programs during runtime, as long as they can locate it. </p>\n<p>What's happening now is that, when we run our file, the operating system is unable to find some shared libraries from OpenCV. We need to find a way to tell it where our shared libraries are.</p>\n<p>The primary way of doing this is linux is by adding a <em>.conf</em> file to <code class=\"language-text\">/etc/ld.so.conf.d/</code>. I've created an opencv.conf file with the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"/home/edujtm/Code/local/OpenCV-3.4.4/lib\"</span> <span class=\"token operator\">></span> opencv.conf</code></pre></div>\n<p><br>\nIf you followed <a href=\"https://www.learnopencv.com/install-opencv-3-4-4-on-ubuntu-18-04/\">the tutorial</a> then your <em>lib</em> folder will probably be located at <code class=\"language-text\">&lt;OpenCV_Home_Dir&gt;/installation/OpenCV-3.4.4/lib</code>. </p>\n<p>Finally, move the new <em>.conf</em> file to <code class=\"language-text\">/etc/ld.so.conf.d/</code> and run ldconfig, which adds the new shared libraries to its cache.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span><span data-user=edujtm data-host=localhost></span></span><span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> opencv.conf /etc/ld.so.conf.d/\n<span class=\"token function\">sudo</span> ldconfig</code></pre></div>\n<p><br>\nBecause this was an OS level issue, your compiled binaries should work just fine, even without recompiling them.</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<h3 id=\"step-1-change-the-g-command-order\" style=\"position:relative;\"><a href=\"#step-1-change-the-g-command-order\" aria-label=\"step 1 change the g command order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1: Change the G++ command order</h3>\n<p>Change the specified command from the tutorial, placing the dependency libraries at the end:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">g++ <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span> my_sample_file.cpp -o my_sample_file\n<span class=\"token comment\"># change to </span>\ng++ my_sample_file.cpp -o my_sample_file <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span></code></pre></div>\n<br/>\n<h3 id=\"step-2-add-shared-libraries-to-etcldsoconfd\" style=\"position:relative;\"><a href=\"#step-2-add-shared-libraries-to-etcldsoconfd\" aria-label=\"step 2 add shared libraries to etcldsoconfd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2: Add shared libraries to /etc/ld.so.conf.d/</h3>\n<p>Create a <em>.conf</em> file pointing to the OpenCV shared libraries folder, place it at <code class=\"language-text\">/etc/ld.so.conf.d/</code> and run ldconfig.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"&lt;OpenCV_Home_Dir>/installation/OpenCV-3.4.4/lib\"</span> <span class=\"token operator\">></span> opencv.conf\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> opencv.conf /etc/ld.so.conf.d/\n<span class=\"token function\">sudo</span> ldconfig</code></pre></div>"}},"pageContext":{"slug":"opencv-header-problems","lang":"en","language":"en","i18n":{"language":"en","languages":["en","pt"],"defaultLanguage":"en","routed":false,"resources":{"en":{"about":{"About me":"About me","my-description":"I'm a student of computer engineering at Universidade Federal do Rio Grande do Norte. I'm interested primarily in topics about Android Development, but I also have a hobbyist interest in Machine Learning and Operating Systems.","need-developer":"Need a developer?","contact-me":"Contact me."},"bloglist":{"Blog":"Blog","blog-description":"Small posts about computer science stuff that I found useful."},"contact":{"contact-info":"Contact Information"},"footer":{"gatsby-credit":"Created by {{creator}} with","fireplace-icon":"Fireplace Icon","by":"by"},"header":{"Edu's coding fireplace":"Edu's coding fireplace","Home":"Home","Blog":"Blog","About":"About","Contact":"Contact"},"home":{"hello":"Hello.","i-am":"I'm","my-place":"This is where I sit down and share my thoughts about coding topics.","my-goal":"Hopefully I'll be able to share useful information to the world, the same way it did for me."}}},"originalPath":"/blog/opencv-header-problems","path":"/blog/opencv-header-problems"}}},"staticQueryHashes":["3159585216","3159585216","440568431"]}