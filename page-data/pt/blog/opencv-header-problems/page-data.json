{"componentChunkName":"component---src-templates-blog-js","path":"/pt/blog/opencv-header-problems","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Consertando erros de linkagem das dependências do OpenCV no Ubuntu 18.04","date":"14/03/2020"},"html":"<h2 id=\"o-problema\" style=\"position:relative;\"><a href=\"#o-problema\" aria-label=\"o problema permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>O problema</h2>\n<p>Adicionar códigos de terceiros em uma aplicação C++ é bem conhecido por não ser uma experiência agradavel, requerindo do usuário o conhecimento de passos do processo de compilação, do ambiente do sistema operacional e a diferença entre os tipos de bibliotecas (linkagem estática ou dinâmica). O problema é tão incômodo que algumas bibliotecas do C++ razoavelmente grandes como <a href=\"https://github.com/catchorg/Catch2\">Catch2</a> e <a href=\"https://www.boost.org/\">Boost</a> oferecem soluções apenas com headers para simplificar a integração da biblioteca no processo de compilação.</p>\n<p>OpenCV é uma biblioteca com várias dependencias e desse modo não está livre desse processo de configuração complexo. Por sorte, alguns usuários experientes da biblioteca fizeram tutoriais detalhados para ajudar iniciantes a se beneficiar da biblioteca, como <a href=\"https://www.learnopencv.com/install-opencv-3-4-4-on-ubuntu-18-04/\">esse aqui</a> que utilizei para instalar a biblioteca no meu computador.</p>\n<p>Eu pensei que após terminar o tutorial, seria possível executar <code class=\"language-text\">g++</code> e seguir com a minha vida, mas isso acabou não sendo verdade, o que me levou em uma jornada de multiplas horas tentando entender se eu havia feito algo de errado. Então decidi escrever este artigo para documentar quais o passos que estavam faltando, caso alguem possua os mesmos problemas que eu.</p>\n<p><em>Se você não quiser ler a explicação dos problemas e quer apenas consertá-las rapidamente, eu fiz um <a href=\"#tldr\">TLDR</a></em></p>\n<h2 id=\"os-passos-que-faltam-para-compilar-corretamente\" style=\"position:relative;\"><a href=\"#os-passos-que-faltam-para-compilar-corretamente\" aria-label=\"os passos que faltam para compilar corretamente permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Os passos que faltam para compilar corretamente</h2>\n<p>No final do tutorial, nós somos instruídos a executar o seguinte comando para compilar o código dependente do OpenCV:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>g++ <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span> my_sample_file.cpp -o my_sample_file</code></pre></div>\n<br/>\n<p>Com <code class=\"language-text\">&lt;OpenCV_Home_Dir&gt;/installation</code> sendo o diretório onde devemos instalar a biblioteca OpenCV. Eu modifiquei este diretório para que ele ficasse de acordo com a minha organização de pastas, então no meu caso a biblioteca foi instalado no seguinte local:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$HOME/Code/local/OpenCV-3.4.4/</code></pre></div>\n<br/>\n<p>Infelizmente, após executar este comando eu estava obtendo várias referência indefinidas para funções do OpenCV.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">hello_world.cpp:(.text+0x5f): undefined reference to &quot;cv::imread(cv::String const&amp;, int)&quot;\nhello_world.cpp:(.text+0xb3): undefined reference to &quot;cv::imshow(cv::String const&amp;, cv::_InputArray const&amp;)&quot;\nhello_world.cpp:(.text+0xdb): undefined reference to &quot;cv::waitKey(int)&quot;</code></pre></div>\n<br/>\n<p>Para entender porque este erro está acontencendo, vamos primeiramente olhar para a saída do comando pkg-config.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>pkg-config --cflags --libs <span class=\"token environment constant\">$HOME</span>/Code/local/OpenCV-3.4.4/lib/pkgconfig/opencv.pc</code></pre></div>\n<br/>\n<p>Executando o comando acima, obtem-se:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-I/home/edujtm/Code/local/OpenCV-3.4.4/include/opencv -I/home/edujtm/Code/local/OpenCV-3.4.4/include -L/home/edujtm/Code/local/OpenCV-3.4.4/lib \n-lopencv_stitching -lopencv_superres -lopencv_videostab -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv \n-lopencv_dnn_objdetect -lopencv_dpm -lopencv_highgui -lopencv_videoio -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs \n-lopencv_img_hash -lopencv_line_descriptor -lopencv_optflow -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo \n-lopencv_structured_light -lopencv_phase_unwrapping -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot \n-lopencv_xfeatures2d -lopencv_shape -lopencv_video -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_imgcodecs \n-lopencv_features2d -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core</code></pre></div>\n<br/>\n<p>Isto é a lista gigante de modulos do OpenCV que você precisa especificar para que o linker seja capaz de encontrar os binários pre-compilados do OpenCV. Você não precisa especificar todos eles, apenas aqueles que você pretende utilizar, mas o pkg-config adicionar todos para que você não tenha problemas ao utilizar diferentes modulos.</p>\n<p>Então essencialmente a mensagem de erro está acontecendo porque o linker não está conseguindo encontrar os binários com a definição da funções do OpenCV, mesmo que elas estejam sendo especificadas na linha de comando.</p>\n<p>O que me surpreendeu foi que a ordem em que você declara as bibliotecas na linha de comando é importante para o processo de linkagem. Isto é explicado brevemente <a href=\"https://stackoverflow.com/questions/31634757/how-to-correct-undefined-reference-error-in-compiling-opencv/31635489#31635489\">nesse comentário de Ivan Aksamentov</a>.</p>\n<blockquote>\n<p>Em suma, a regra \"bibliotecas vêm antes dos objetos que as usam\" é imposta por várias distribuições do GCC para linkar bibliotecas apenas quando elas são necessárias. No seu caso, o arquivo de objeto facerec_eigenfaces.o, que é produzido pelo código fonte facerec_eigenfaces.cpp, depende das bibliotecas OpenCV (a lista exata é dada pelo comando pkg-config), e assim as bibliotecas devem vir após aquele arquivo. Você pode também notar esse padrão na saída do comando pkg-config: por exemplo, X11, pthreads e outras dependências do sistema linux aparecem depois das dependências em bibliotecas OpenCV.</p>\n</blockquote>\n<p>De forma breve: se o seu código fonte depende de um arquivo linkado, ele deve aparecer antes do arquivo linkado na linha de comando. Seguindo isso, a forma correta de fazer a chamada do comando é colocando o pkg-config depois dos arquivos, desse modo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>g++ my_sample_file.cpp -o my_sample_file <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span></code></pre></div>\n<br/>\n<p>Após consertar isto, os arquivos passaram a compilar corretamente. Mas agora o seguinte estava ocorrendo no runtime:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./hello_world: error while loading shared libraries: libopencv_highgui.so.3.4: cannot open shared object file: No such file or directory</code></pre></div>\n<br/>\n<p>Bom, progredimos um pouco, mas ainda não estamos lá. Nós movemos de um problema de linkagem para um problema de biblioteca compartilhada. A biblioteca é chamada de compartilhada devido ao fato de apenas um único binário poder ser utilizado por vários programas no runtime, contando que eles possam encontrá-lo.</p>\n<p>O que está acontecendo agora é que, quando executamos o arquivo, o sistema operacional é incapaz de encontrar algumas bibliotecas compartilhadas do OpenCV. Nós precisamos passar a informação sobre onde as bibliotecas estão localizadas pro SO de alguma forma.</p>\n<p>A forma recomendada de fazer isso no linux é adicionando um arquivo <em>.conf</em> em <code class=\"language-text\">/etc/ld.so.conf.d</code>. Eu criei um arquivo <em>opencv.conf</em> com o seguinte conteúdo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"/home/edujtm/Code/local/OpenCV-3.4.4/lib\"</span> <span class=\"token operator\">></span> opencv.conf</code></pre></div>\n<br/>\n<p>Se você seguiu <a href=\"https://www.learnopencv.com/install-opencv-3-4-4-on-ubuntu-18-04/\">o tutorial</a> seu diretório <em>lib</em> deve estar localizado em <code class=\"language-text\">&lt;OpenCV_Home_Dir&gt;/installation/OpenCV-3.4.4/lib</code> .</p>\n<p>Por fim, movemos o arquivo <em>.conf</em> para <code class=\"language-text\">/etc/ld.so.conf.d/</code> e rodamos ldconfig, que irá adicionar as novas bibliotecas compartilhadas em sua cache.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span><span data-user=edujtm data-host=localhost></span></span><span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> opencv.conf /etc/ld.so.conf.d/\n<span class=\"token function\">sudo</span> ldconfig</code></pre></div>\n<br/>\n<p>Já que isso era um problema a nível de sistema operacional, seus binários compilados devem funcionar corretamente, mesmo sem precisar refazer a compilação.</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<h3 id=\"passo-1-mude-a-ordem-do-comando-g\" style=\"position:relative;\"><a href=\"#passo-1-mude-a-ordem-do-comando-g\" aria-label=\"passo 1 mude a ordem do comando g permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Passo 1: Mude a ordem do comando g++</h3>\n<p>Mude o comando descrito no tutorial, colocando as bibliotecas dependentes no final:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">g++ <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span> my_sample_file.cpp -o my_sample_file\n<span class=\"token comment\"># Mude para </span>\ng++ my_sample_file.cpp -o my_sample_file <span class=\"token variable\"><span class=\"token variable\">`</span>pkg-config --cflags --libs <span class=\"token operator\">&lt;</span>OpenCV_Home_Dir<span class=\"token operator\">></span>/installation/OpenCV-3.4.4/lib/pkgconfig/opencv.pc<span class=\"token variable\">`</span></span></code></pre></div>\n<br/>\n<h3 id=\"passo-2-adicione-bibliotecas-compartilhadas-em-etcldsoconfd\" style=\"position:relative;\"><a href=\"#passo-2-adicione-bibliotecas-compartilhadas-em-etcldsoconfd\" aria-label=\"passo 2 adicione bibliotecas compartilhadas em etcldsoconfd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Passo 2: Adicione bibliotecas compartilhadas em /etc/ld.so.conf.d/</h3>\n<p>Crie um arquivo <em>.conf</em> apontando para o diretório de bibliotecas compartilhadas do OpenCV. Coloque-o em <code class=\"language-text\">/etc/ld.so.conf.d/</code> e execute ldconfig.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"&lt;OpenCV_Home_Dir>/installation/OpenCV-3.4.4/lib\"</span> <span class=\"token operator\">></span> opencv.conf\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> opencv.conf /etc/ld.so.conf.d/\n<span class=\"token function\">sudo</span> ldconfig</code></pre></div>"}},"pageContext":{"slug":"opencv-header-problems","lang":"pt","language":"pt","i18n":{"language":"pt","languages":["en","pt"],"defaultLanguage":"en","routed":true,"resources":{"pt":{"about":{"About me":"Sobre mim","my-description":"Eu sou um estudante de Engenharia da Computação na Universidade Federal do Rio Grande do Norte. Tenho interesse sobre tópicos relacionados a desenvolvimento mobile para Android, mas também possuo como hobby o estudo de tópicos sobre Aprendizagem de Máquina e Sistemas Operacionais.","need-developer":"Precisa de um desenvolvedor?","contact-me":"Entre em contato comigo."},"bloglist":{"Blog":"Blog","blog-description":"Pequenos posts sobre tópicos de ciências da computação que eu achei interessante."},"contact":{"contact-info":"Informações de contato"},"footer":{"gatsby-credit":"Criado por {{creator}} usando","fireplace-icon":"Ícone de lareira","by":"por"},"header":{"Edu's coding fireplace":"Lareira de código do Edu","Home":"Home","Blog":"Blog","About":"Sobre","Contact":"Contato"},"home":{"hello":"Olá.","i-am":"Eu sou","my-place":"este é o lugar onde eu expresso meus pensamentos sobre assuntos que envolvem programação.","my-goal":"Espero poder compartilhar informações úteis para o mundo, da mesma forma que fizeram por mim."}}},"originalPath":"/blog/opencv-header-problems","path":"/pt/blog/opencv-header-problems"}}},"staticQueryHashes":["3159585216","3159585216","440568431"]}