{"componentChunkName":"component---src-templates-blog-js","path":"/pt/blog/opencv-image-manipulation","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Manipulando imagens utilizando região de interesse no OpenCV","date":"04/10/2020"},"html":"<h2 id=\"manipulação-de-imagens\" style=\"position:relative;\"><a href=\"#manipula%C3%A7%C3%A3o-de-imagens\" aria-label=\"manipulação de imagens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Manipulação de imagens</h2>\n<p>Uma das tarefas mais básicas quando manipulamos imagens é aplicar uma certa operação à uma subseção de uma imagem. Nós podemos querer modificar uma certa porção da imagem para que ela fique destacada ou aplicar um efeito especial para uma região especificada. A biblioteca do OpenCV oferece diversas formas para fazer estas operações, as quais espero mostrar em alguns exemplos neste artigo.</p>\n<p>Para mostrar estes diferentes tipos de operações, nós faremos um programa simples que modifica uma subseção da imagem para seu negativo.  A wikipedia define uma <a href=\"https://en.wikipedia.org/wiki/Negative_(photography)\">imagem negativa</a> como:</p>\n<blockquote>\n<p>Em fotografia, um negativo é uma imagem, usualmente em uma linha ou folha de papel filme transparente, onde as partes mais claras do objeto fotografado aparecem escuras e as áreas escuras aparecem claras.</p>\n</blockquote>\n<p>Então o programa precisa pegar a imagem e modificar suas seções claras para escura e vice versa. Nós vamos pedir ao usuário que especifique dois pontos na imagem que definem os cantos superior esquerdo e inferior direito de uma seção retangular onde nós iremos aplicar a operação. Para simplificar o trabalho, nós vamos redimensionar a imagem para que tenha 200 pixels de largura e altura, permitindo que possamos checar por acessos inválidos ao array.</p>\n<h3 id=\"o-modo-ingênuo\" style=\"position:relative;\"><a href=\"#o-modo-ing%C3%AAnuo\" aria-label=\"o modo ingênuo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>O modo ingênuo</h3>\n<p>Se você pensar em uma imagem como um array 2D, a primeira forma que vem a mente de manipular a imagem é utilizar dois loops <em>for</em> e modificar os pixels um por um. OpenCV oferece duas funções para acessar os pixels de uma imagem:</p>\n<ul>\n<li><a href=\"https://docs.opencv.org/4.4.0/d3/d63/classcv_1_1Mat.html#ac40425b84f60b39fd35e03814122661f\">Mat::at(x, y)</a> - Retorna uma referência para o valor na linha x e coluna y </li>\n<li><a href=\"https://docs.opencv.org/4.4.0/d3/d63/classcv_1_1Mat.html#abda2b96aa438a808b43425040a7da81a\">Mat::ptr(x, y)</a> - Retorna um ponteiro para o valor na linha x e coluna y. </li>\n</ul>\n<p>Essas funções possuam várias redefinições para que possamos retornar o tipo correto do ponteiro para os diferentes tipos de dados que cv::Mat suporta. Se você não especificar o tipo, um ponteiro simples para <code class=\"language-text\">unsigned char</code> será retornado, mesmo que este não seja o tipo que o cv::Mat contêm e nós precisariamos ter mais cuidado ao fazer aritmética com os ponteiros.</p>\n<p>Com isso em mente, vamos fazer nossa primeira implementação do programa utilizando uma dessas funções:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;opencv2/opencv.hpp></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cxxopts.hpp></span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string file_path<span class=\"token punctuation\">;</span>              <span class=\"token comment\">// Caminho da imagem no sistema</span>\n\t<span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> top_left<span class=\"token punctuation\">;</span>       <span class=\"token comment\">// coordenadas x &amp; y superior esquerdas</span>\n\t<span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> lower_right<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// coordenadas x &amp; y inferior direitas </span>\n<span class=\"token punctuation\">}</span>\n\nConfig <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* parse cli */</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/*\n * forma ingênua de resolver o problema\n */</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat image <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>IMREAD_GRAYSCALE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Redimensionando a imagem para 200x200</span>\n    cv<span class=\"token operator\">::</span>Mat small_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Size size <span class=\"token punctuation\">{</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Renomeando porque Point2i possui atributos mais descritivos que std::pair</span>\n    cv<span class=\"token operator\">::</span>Point2i top_left <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point2i lower_right <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Iterando pela região</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> lower_right<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> lower_right<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            uchar <span class=\"token operator\">*</span>value <span class=\"token operator\">=</span> small_image<span class=\"token punctuation\">.</span>ptr<span class=\"token operator\">&lt;</span>uchar<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">*</span>value <span class=\"token operator\">=</span> <span class=\"token number\">255</span> <span class=\"token operator\">-</span> <span class=\"token operator\">*</span>value<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Faz a inversão de 8 bits para obter o negativo </span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"negative\"</span><span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Com essa implementação, nós podemos executar o binário na linha de comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./regions chip-grayscale.jpg --tlx <span class=\"token number\">50</span> --tly <span class=\"token number\">55</span> --lrx <span class=\"token number\">160</span> --lry <span class=\"token number\">150</span></code></pre></div>\n<br/>\n<p>E obter o resultado esperado:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADgUlEQVQ4yyWUyS8sURjFb4hxIVjpIKaY53meaZo82tBmgkbMIbHoFhZitsIOCxLEkGCBoAUPT8wxpEWIHQsrf8P7qbpJd25V3XO+c873VYnY2NiAgAAHBwd/f/+YmBgfHx97e3svL6+4uLjQ0FDum5mZmZqaWlpampiYaLVaHmVkZNTV1eXm5gp2KSkpTk5OwNzc3EJCQqBQqVTJycnsg4KCXF1dbWxsAHNzfHy8oaFBqVRqNJqKigqhUChycnJAmpubW1hYREZGpqamgiwuLk5MTPT19U1ISIiOjqZGTU1NV1dXZ2cnLECysrIEv/z8fIrY2dlxFDE8Ky8vLyoqSktLQxHnCgsL+/v7NdJqbm4uLS2l+C84MzOTasBQiP+8vDxgjY2N2CsrKwNcUFAAe2tra319PaTcREJJSUlSUpLghzyQ4Nn39vaOjo4ODg729fW1tbVxyZ47Q0NDHR0dYIiquroaw9nZ2QJ7kKEtLCwMn/Pz8zMzM1NTU5OTk7Ozs4eHh3+lxWZkZKSlpQXGyspKjKBCwEEM2CBzBK+srKyvr6+urh4cHJycnOzv7+/u7i4vL3N/YGAAJPqBIVatVov29vbu7m6sck1CBoPh9vb2n7S2t7eXlpYAQzc3N4fyqqoqkCRKR+Lj48X09DTGoGEkGIyHh4fHx8ejo6PFxUUUcXRhYWFra4t/nU4n55yenk7/OC+gRAw94JpRo8jl5SWCcWhra0uFzc1NuDY2NjhGTcrIFIgV+GFHZvSN2QJ8dXWFYZIDT1TIPj4+fnp6Ghsbwxq51NbWop96gkj+SAsPpL+zs3N2dnZ6eorhi4sLg7TOz8/f398nJiaYCEYNGBQ0SBAMO8ZAKa21tbW9vb2bmxsogFH57u7u9fX15+eHbmMNjDxI7AWPe3p6MIMT+ixni2ySu76+fnl5+fz8hIg+A2aKyAmD+GccBdkwrohRS+vt7e3+/v75+fnr6+v7+/vj44OynDEajTKYWeRFiIqK8vDwEOTOeCObJkM5PDwszyMO5T1Lr9czIcw2rxdIR0dH3tNfMGTkRGU28Hl6ekZERPBh4KUnQqgJiZ5ZWVnRSDS7u7sDc3Fx+QU3NTU5OzsHBgaGh4cDCw4O5g1hWhBCC8iCsfX29oYUOk4CoyyfDf4FGGtrazDogQJ6PgyEgRfwNBZGPz8/TgPjESxyWSD/AXpmxp/Q98/sAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Negative image with for loops\"\n        title=\"Negative image with for loops\"\n        src=\"/static/85e337792779ec3898358465d2f4f937/772e8/negative-for-loop.png\"\n        srcset=\"/static/85e337792779ec3898358465d2f4f937/4dcb9/negative-for-loop.png 188w,\n/static/85e337792779ec3898358465d2f4f937/772e8/negative-for-loop.png 200w\"\n        sizes=\"(max-width: 200px) 100vw, 200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>A parte que nos interessa do código acima são os dois loops for:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// Iterate through the region </span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> lower_right<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> lower_right<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        uchar <span class=\"token operator\">*</span>value <span class=\"token operator\">=</span> small_image<span class=\"token punctuation\">.</span>ptr<span class=\"token operator\">&lt;</span>uchar<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token operator\">*</span>value <span class=\"token operator\">=</span> <span class=\"token number\">255</span> <span class=\"token operator\">-</span> <span class=\"token operator\">*</span>value<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Faz a inversão de 8 bits para obter o negativo</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Nesse código estamos pedindo ao OpenCV que calcule o deslocamento do início do array de dados onde nosso pixel está localizado, então salvamos o resultado de 255 menos o valor naquela posição. O problema com esta implementação é que, para calcular o deslocamento, nós precisamos fazer uma multiplicação para encontrar a linha e então um soma para encontrar o local do pixel, repetindo este processo <strong>para todos os pixels</strong> da região. Essa <a href=\"https://stackoverflow.com/a/25224916/8310836\">resposta do stackoverflow</a> explica este problema e mostra uma forma de resolvê-lo.</p>\n<h3 id=\"utilizando-operadores-roi\" style=\"position:relative;\"><a href=\"#utilizando-operadores-roi\" aria-label=\"utilizando operadores roi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Utilizando operadores ROI</h3>\n<p>Já que estamos aplicando a mesma operação em todos os pixels de dentro da região, nós podemos então utilizar uma operação de broadcasting dentro da região de interesse, o que irá fazer com que nosso código fique mais curto e mais legível.</p>\n<p>O OpenCV sobrecarrega o <a href=\"https://docs.opencv.org/4.4.0/d3/d63/classcv_1_1Mat.html#ad543b6bd296ae1247032c750af4718e1\">Mat::operator()</a> para que possamos extrair subregiões da imagem. Essa subseção extraída não é uma cópia dos valores, apenas uma cópia do cabeçalho que aponta para o mesmo array de dados. Dessa forma, operações na submatriz extraída serão refletidas na imagem original.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/*\n * ROI e broadcasting.\n */</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat image <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>IMREAD_GRAYSCALE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Redimensionando a imagem para 200x200</span>\n    cv<span class=\"token operator\">::</span>Mat small_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Size size <span class=\"token punctuation\">{</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Renomeando porque Point2i possui atributos mais descritivos que std::pair</span>\n    cv<span class=\"token operator\">::</span>Point2i top_left <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point2i lower_right <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Uma forma melhorada utilizando regiões de interesse (ROI)</span>\n    <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> width <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect roi <span class=\"token punctuation\">{</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Obtem uma view da seção onde iremos fazer a operação</span>\n    cv<span class=\"token operator\">::</span>Mat image_roi <span class=\"token operator\">=</span> <span class=\"token function\">small_image</span><span class=\"token punctuation\">(</span>roi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Aplica a operação de broadcasting</span>\n    image_roi <span class=\"token operator\">=</span> <span class=\"token number\">255</span> <span class=\"token operator\">-</span> image_roi<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"negative\"</span><span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Se nós executarmos o binário com essa implementação:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./regions chip-grayscale.jpg --tlx <span class=\"token number\">20</span> --tly <span class=\"token number\">20</span> --lrx <span class=\"token number\">100</span> --lry <span class=\"token number\">60</span></code></pre></div>\n<br/>\n<p>Nós obtemos o resultado desejado novamente:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADS0lEQVQ4yyWUyUuCQRjGh0KIDh2CIlrI0ha1RSsqs9IWUzOzssVsT4tKKyUPBZ26dQqCTh2lDhGEyyGQFkgSWk4dunQPunjoH+iX3wcN48w8yzzvOwm9Xq/RaIqKiurr69va2mpqagoLC2tra7u6unQ6XUlJiUwmy83NzcvLy8nJ8Xq9bA0ODq6srNjtdsGsr69PpVK1trZyGq7Ozk6bzWY0GrVabVNTk1wuLygoAMzi8fGxz+cbGhqampryeDwC7rGxsZeXl+/v75+fn2QyCV1vb+/k5GRPTw+k3d3dHR0dLC4uLgaDwZ2dHViGh4ctFouAhnOvr6+/v79fX183NzcjIyMzMzMs9vf3l5aWWq1W2A8PD1lBcGNjg11Q/2BOoPD+/v7x8ZFOpy8uLubn5zc3N7HHUYVC4cl+oVCIldnZWbfbjYXp6WncCVxhCdjn5+fz8/PV1dXy8vLa2tr+/v7R0ZHD4cDIwMAAeNZBEtXCwgI/cSQgYCkWi729vSUSibOzM2RD2Q+HgLGHSSh2d3e3t7e3trbm5uYmJiZwIfjj3PX19d3dXTQajUQi7HE9AATOSDywI4UmgUENhJsShPD7/Xt7e/F4/OnpCduPj48mk4l4DQYDahARLFwIEgF1hgg6qssBcXp6enBwwFWBgb+9vSUFNInt5OTk8vJyaWnJ6XSSwurqKvpms5kIOENTiPPz80AgQAbw0RUQQ4k4jJlM5v7+fnx8nJ9YgI6ugkgq1ejoqKA2UsdACRgKmow52YLHArYZaTuiZZersgUREIFPR/Zjj0OUnZE5F6a9zdmPSXNzM3gMc1tgLpcLUpFKpZhhhrqRIRi88UKYA4OInucxlJeXkyLKVA7DQLi2IKdwOMwqBQDJ9ege2oYnAYVaraZD0USHLUbWwVMjbiceHh5oBvxAhlRdXR1qiDCpqqpibGlpAQOdNfs1NDQQTXt7O50rgIHBtvQ2UQPMHg8bYzQGP6mK9MK5C8plZWW8038w2cAnPUME0ZGUwWOP6+CW08XFxWyhWV1dDayysvIfvL6+XlFR0djYSDDI4gqrgKEgOSlFXIBRKpWcBIYsN2IUYPLz86kErFAA5v+RVGrptUqxcRoYWxBJskD+AHNeeh+0sMLPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Negativo da imagem utilizando região de interesse\"\n        title=\"Negativo da imagem utilizando região de interesse\"\n        src=\"/static/41dbf90f330f231f94f561d98277b148/772e8/roi-negative-image.png\"\n        srcset=\"/static/41dbf90f330f231f94f561d98277b148/4dcb9/roi-negative-image.png 188w,\n/static/41dbf90f330f231f94f561d98277b148/772e8/roi-negative-image.png 200w\"\n        sizes=\"(max-width: 200px) 100vw, 200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"utilizando-operadores-bit-a-bit\" style=\"position:relative;\"><a href=\"#utilizando-operadores-bit-a-bit\" aria-label=\"utilizando operadores bit a bit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Utilizando operadores bit a bit</h3>\n<p>Já que uma imagem em tons de cinza com um único canal é representada por valores de 8 bits, nós podemos utilizar operadores bitwise para inverter a imagem. Se nós invertemos os bits de cada pixel, obteremos o mesmo valor que ao subtrair a intensidade de 255.</p>\n<ul>\n<li>0 (0b0000_0000) -> 255 (0b1111_1111)</li>\n<li>1 (0b0000_0001) -> 254 (0b1111_1110)</li>\n<li>2 (0b0000_0010) -> 253 (0b1111_1101)</li>\n</ul>\n<p>E assim por diante...</p>\n<p>Com isso em mente, nós podemos reescrever nossa operação utilizando a função <a href=\"https://docs.opencv.org/4.4.0/d2/de8/group__core__array.html#ga0002cf8b418479f4cb49a75442baee2f\">cv::bitwise_not()</a></p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/*\n * ROI e operação bitwise\n */</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat image <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>IMREAD_GRAYSCALE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Redimensionando a imagem para 200x200</span>\n    cv<span class=\"token operator\">::</span>Mat small_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Size size <span class=\"token punctuation\">{</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Renomeando porque Point2i possui atributos mais descritivos que std::pair</span>\n    cv<span class=\"token operator\">::</span>Point2i top_left <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>top_left<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point2i lower_right <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>lower_right<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Criando a região de interesse</span>\n    <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> width <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect roi <span class=\"token punctuation\">{</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Obtem uma view da seção onde iremos fazer a operação</span>\n    cv<span class=\"token operator\">::</span>Mat image_roi <span class=\"token operator\">=</span> <span class=\"token function\">small_image</span><span class=\"token punctuation\">(</span>roi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Aplica a operação de bitwise_not</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">bitwise_not</span><span class=\"token punctuation\">(</span>image_roi<span class=\"token punctuation\">,</span> image_roi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"negative\"</span><span class=\"token punctuation\">,</span> small_image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Ao executar o binário resultante, você irá obter os mesmos resultados de antes.</p>\n<h3 id=\"comparação-de-performance\" style=\"position:relative;\"><a href=\"#compara%C3%A7%C3%A3o-de-performance\" aria-label=\"comparação de performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comparação de performance</h3>\n<p>A última questão sobrando é se esta refatoração vale a pena em termos de performance. Se o ganho de performance ao utilizar o operador bit a bit não for razoável, nós podemos optar pelo uso de uma implementação mais simples.</p>\n<p>Para testar a performance dos três scripts, eu usei a <a href=\"https://unsplash.com/photos/vruAZdZzQR0\">imagem original</a> que possui um tamanho de 3632 x 5456 pixels e removi as restrições das dimensões da imagem serem 200 x 200. Após isso, eu cobri as chamadas das operações com chamadas para <a href=\"https://cplusplus.com/reference/chrono/\">std::chrono</a> e executei o script para inverter uma subregião de 1000 x 1000 pixels.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">    <span class=\"token keyword\">auto</span> begin <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>chrono<span class=\"token operator\">::</span>steady_clock<span class=\"token operator\">::</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// A better way using region of interest </span>\n    <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> width <span class=\"token operator\">=</span> lower_right<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect roi <span class=\"token punctuation\">{</span> top_left<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> top_left<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Obtains a view of the section in which we're going to make the operation;</span>\n    cv<span class=\"token operator\">::</span>Mat image_roi <span class=\"token operator\">=</span> <span class=\"token function\">image</span><span class=\"token punctuation\">(</span>roi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Applies a broadcasting operation</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">bitwise_not</span><span class=\"token punctuation\">(</span>image_roi<span class=\"token punctuation\">,</span> image_roi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">auto</span> end <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>chrono<span class=\"token operator\">::</span>steady_clock<span class=\"token operator\">::</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Time elapsed (roi-bitwise): \"</span> <span class=\"token operator\">&lt;&lt;</span> \n          std<span class=\"token operator\">::</span>chrono<span class=\"token operator\">::</span>duration_cast<span class=\"token operator\">&lt;</span>std<span class=\"token operator\">::</span>chrono<span class=\"token operator\">::</span>microseconds<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>end <span class=\"token operator\">-</span> begin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n          <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[us]\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span></code></pre></div>\n<br />\n<p>Estes foram os resultados obtidos:</p>\n<table>\n<thead>\n<tr>\n<th>Script</th>\n<th>Tempo decorrido (g++ -O2)</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>for-loop</td>\n<td>1308 (+/- 77) [µs]</td>\n<td></td>\n</tr>\n<tr>\n<td>roi-broadcasting</td>\n<td>67 (+/- 44) [µs]</td>\n<td></td>\n</tr>\n<tr>\n<td>roi-bitwise</td>\n<td>45 (+/- 46) [µs]</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>Eu executei os scripts diversas vezes e o tempo de execução flutua ao redor desses valores. Como podemos ver a versão com loop for é um ordem de magnitude mais lenta e nós devemos evitar usá-la caso haja uma melhor opção disponível.</p>\n<h3 id=\"um-último-exemplo-de-operadores-roi\" style=\"position:relative;\"><a href=\"#um-%C3%BAltimo-exemplo-de-operadores-roi\" aria-label=\"um último exemplo de operadores roi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Um último exemplo de operadores ROI</h3>\n<p>Outro exemplo onde operadores de região de interesse podem ser úteis se dá ao criar um deslocamento de quadrantes de uma imagem, onde você troca o quadrante superior esquerdo com o inferior direito e o quadrante superior direito com o inferior esquerdo. Um exemplo disso é mostrado abaixo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAC+0lEQVQ4yyXUNU4EYRQH8ElIsISCAhLcNbjbLu7u7iRI8AICoaWgoeAAcAU6CNyIU/DbnSkm37x5f3kyE/z8/CwsLPT19W1sbGxubk5NTc3Ozq6trQ0ODrq/vb1dXFysrKz09vaWlpbOzMx0d3c7Pz4+/v39BWCTk5PuHR0d0Wh0fHx8bm5ub29vdXX15OTk/f1dBHhsbKy5uRl1V1fX8PDw7u4ufDA6OupBqL6+Hp5gf3+/7FD/8/PTAQYvwYGBAXdnkc7OzpgyyvLy8tzc3Pb2djro2Jufn5f6+/u7vLzskXIkEoFhs6WlxXloaCioqqrKzs6mOTExgci9rq4O/uzsDPf39/fd3R3k+vo6pASmwOSgCCoqKpqammCExuJXTU1NQ0ODd5WVlV9fX1jUsri4qDrJbDPoUFRUFGxvb+NrbGzkXOX8YM3JySkoKKiurpY6MjLCNmq9wCjS1tZWVlam7QEpYNmZmZks0CwuLi4pKSksLMStNxIgHQhKCJXhlRbrtheYYNzz8vJCGGWDPTg4yM/PDyt0qYhhDQq7E7BKTXkA8rzD4iwCQyo1NdVBCbW1tcCqU6NBqCIwoeTk5MTExJSUlISEBFJee7ezs8Nwa2srlqysLEhWUWdkZIgoGEWAlcO0tLSkpCRDfnl5OTw8VIsNsyRhnwiEjnhUMFKVx8CeOVeGPGrX19eXl5dYLAOYFjiTYg07I4KQS0tL5hLoMx37/PT0JGSfrDRZEzJYItaTQHp6unXSJMkWxthjG8azj8kndXNzc3R05AW3LGChYD2oganOwgnKtDZKIxCb8/T0tCRRHxPk/v6+zfFIJBK/wm5rksytra3j4+P7+/vn5+dAbZKYtLpXV1e+XsS8MIYIkhduDRmS4Pn5OY9ac3p6GoBpiTxSNMMoAJgPC4sIh/rk0W9jJX5BWa2ADcRaRVBJuBGhk93T04Po9vbWbkfjl4hpm44Dy8HHx4cKtfQwftHHaklUaH6vr68PDw/A4Xr6Yfj4wwbZiH+o/kWBnk4UcQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imagem de um chip com quadrantes trocados\"\n        title=\"Imagem de um chip com quadrantes trocados\"\n        src=\"/static/3d5ce410ce685ac929e83cbd8f8feb11/772e8/shift-chip.png\"\n        srcset=\"/static/3d5ce410ce685ac929e83cbd8f8feb11/4dcb9/shift-chip.png 188w,\n/static/3d5ce410ce685ac929e83cbd8f8feb11/772e8/shift-chip.png 200w\"\n        sizes=\"(max-width: 200px) 100vw, 200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>A primeira vista, pode parecer que nós precisariamos iterar por metade da imagem, calculando a nova posição para cada pixel e por fim trocá-los de posição, mas esse resultado pode ser alcançado de forma mais simples utilizando uma região de interesse para cada quadrante da imagem, copiando os valores entre eles. A implementação é dada abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> file_path <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n    <span class=\"token comment\">// Lê a imagem</span>\n    cv<span class=\"token operator\">::</span>Mat image <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>IMREAD_GRAYSCALE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat squared_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Size size <span class=\"token punctuation\">{</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> squared_image<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    image <span class=\"token operator\">=</span> squared_image<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"before\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Quadrantes</span>\n    cv<span class=\"token operator\">::</span>Rect top_left <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect lower_left <span class=\"token punctuation\">{</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect top_right <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Rect lower_right <span class=\"token punctuation\">{</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Deslocando quadrantes</span>\n    cv<span class=\"token operator\">::</span>Mat temp <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token class-name\">Mat</span><span class=\"token operator\">::</span><span class=\"token function\">zeros</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> CV_8UC1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// trocando superior esquerdo com inferior direito</span>\n    <span class=\"token keyword\">auto</span> top_left_view <span class=\"token operator\">=</span> <span class=\"token function\">image</span><span class=\"token punctuation\">(</span>top_left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> lower_right_view <span class=\"token operator\">=</span> <span class=\"token function\">image</span><span class=\"token punctuation\">(</span>lower_right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    top_left_view<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>temp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    lower_right_view<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>top_left_view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    temp<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>lower_right_view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n\t\t<span class=\"token comment\">// Trocando superior direito com inferior esquerdo</span>\n    <span class=\"token keyword\">auto</span> top_right_view <span class=\"token operator\">=</span> <span class=\"token function\">image</span><span class=\"token punctuation\">(</span>top_right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> lower_left_view <span class=\"token operator\">=</span> <span class=\"token function\">image</span><span class=\"token punctuation\">(</span>lower_left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    top_right_view<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>temp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    lower_left_view<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>top_right_view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    temp<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>lower_left_view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after shifting\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Após algumas cópias de dados, nós obtemos a troca de quadrantes desejada. Isto é muito mais legivel do que calcular uma nova posição para cada pixel em um loop for.</p>\n<p>O problema com essa implementação é que ela assume que a altura e largura da imagem são divisiveis por 2. Uma implementação mais robusta checaria o tamanho da imagem e trataria o erro de forma correta.</p>"}},"pageContext":{"slug":"opencv-image-manipulation","lang":"pt","language":"pt","i18n":{"language":"pt","languages":["en","pt"],"defaultLanguage":"en","routed":true,"resources":{"pt":{"about":{"About me":"Sobre mim","my-description":"Eu sou um estudante de Engenharia da Computação na Universidade Federal do Rio Grande do Norte. Tenho interesse sobre tópicos relacionados a desenvolvimento mobile para Android, mas também possuo como hobby o estudo de tópicos sobre Aprendizagem de Máquina e Sistemas Operacionais.","need-developer":"Precisa de um desenvolvedor?","contact-me":"Entre em contato comigo."},"bloglist":{"Blog":"Blog","blog-description":"Pequenos posts sobre tópicos de ciências da computação que eu achei interessante."},"contact":{"contact-info":"Informações de contato"},"footer":{"gatsby-credit":"Criado por {{creator}} usando","fireplace-icon":"Ícone de lareira","by":"por"},"header":{"Edu's coding fireplace":"Lareira de código do Edu","Home":"Home","Blog":"Blog","About":"Sobre","Contact":"Contato"},"home":{"hello":"Olá.","i-am":"Eu sou","my-place":"e este é o lugar onde eu expresso meus pensamentos sobre assuntos que envolvem programação.","my-goal":"Espero poder compartilhar informações úteis para o mundo, da mesma forma que fizeram por mim."},"projects":{"diversify":{"header":"Diversify - Gerador de playlists para o Spotify","content":"Um gerador de playlist para o Spotify que busca satisfazer mutualmente, da melhor forma possível, os gostos musicais de um grupo de usuários. O gerador usa um algoritmo de clustering para detectar padrões de gosto de cada usuário e para decidir qual musica está mais próxima do gosto músical coletivo dos usuários.\n\n Um website feito com Django e React está atualmente sendo desenvolvido para hospedar o algoritmo.","url":"https://github.com/edujtm/diversify"},"tuyo":{"header":"Tuyo - Gerenciador de playlists para o YouTube","content":"Um aplicativo nativo para Android feito utilizando Kotlin que permite o gerenciamento em grupo (i.e. copiar, colar e recortar) de playlists do YouTube. O aplicativo segue o guia de arquitetura do Android utilizando os componentes de arquitetura do Jetpack para gerenciar o ciclo de vida, injeção de dependências com Dagger e Espresso e JUnit para testes funcionais e unitários, respectivamente. \n\n Nesse projeto eu aprendi um pouco mais sobre como gerenciar o ciclo de vida dos componentes principais do Android, evitando problemas de memória, e como criar uma cache dos dados de uma API de terceiros.","url":"https://github.com/edujtm/tuyo"},"personal-website":{"header":"Site pessoal - Gatsby.js","content":"Este website foi desenvolvido utilizando Gatsby.js e GraphQL para obter um design responsivo e produzir conteudo gratuito para pessoas interessadas em programação. O site utiliza i18next para internacionalização de todo o conteúdo do site e está atualmente sendo migrado para TypeScript.","url":"https://github.com/edujtm/edujtm.github.io"}}}},"originalPath":"/blog/opencv-image-manipulation","path":"/pt/blog/opencv-image-manipulation"}}},"staticQueryHashes":["3159585216","3159585216","440568431"]}