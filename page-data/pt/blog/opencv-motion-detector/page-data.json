{"componentChunkName":"component---src-templates-blog-js","path":"/pt/blog/opencv-motion-detector","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Detectando movimentos através da manipulação de histogramas com OpenCV","date":"24/10/2020"},"html":"<p>Suponha que seu chefe peça para que você implemente um detector de movimentos para sua empresa, mas você nunca fez isso anteriormente e ele te deu uma prazo para conclusão bem curto. A primeira vista, parece que detectar movimentos em uma imagem pode ser uma tarefa difícil: Como nós podemos definir o que é um movimento em um grupo de pixels se não temos nenhuma informação do relacionamento entre eles? Se nós tentarmos processar pixels individualmente para checar se eles mudaram suas posições, isto com certeza irá gerar umas dores de cabeça.</p>\n<p>Você então busca na internet por outras soluções e encontra que as técnicas de processamento de imagem atuais permitem o uso de vários métodos de detecção de movimentos em um video utilizando técnicas de segmentação para separar objetos em primeiro plano do fundo da imagem. Essas técnicas muitas vezes utilizam truques matemáticos complexos que podem ser difíceis de entender para um iniciante, então nós devemos buscar por uma implementação mais simples que, embora não seja tão robusta, ainda dá conta do trabalho.</p>\n<p>Felizmente há uma forma mais simples de fazer isso se pensarmos sobre as propriedades da imagem por completo ao invés de seus componentes. Se nós assumirmos que um objeto em movimento irá introduzir novos pixels na imagem, ou do fundo atrás do objeto, ou do própio objeto ao entrar no quadro, nós podemos usar a alteração nas quantidades de cada intensidade dos pixels por toda a imagem para determinar se há movimento. A representação da frequência de dados em uma amostra é dada pelo histograma. Já que trabalhar com histogramas é bem útil em visão computacional, OpenCV oferece um conjunto de ferramentos para criar e manipular esse tipo de representação de dados.</p>\n<h2 id=\"entendendo-histogramas-no-opencv\" style=\"position:relative;\"><a href=\"#entendendo-histogramas-no-opencv\" aria-label=\"entendendo histogramas no opencv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entendendo histogramas no OpenCV</h2>\n<p>Antes de implementarmos nosso detector de moviments, nós precisamos entender o que é um histograma e como trabalhar com eles no OpenCV. Quando se trata de imagens, o histograma é uma representação das frequências de todas as intensidades de seus pixels. Isto é feito ao separar a faixa de valores das intensidades em partições e contando todos os pixels cuja intensidade esteja dentro dos limites da partição. No caso mais simples, onde o número de partições é o mesmo que a quantidade de valores na faixa de intensidades, nós obtemos um histograma como esse:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.42553191489361%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA30lEQVQoz3WRi4rEIAxF+/+fWmjpdHy0Gs14wqS4Axu4xEdyvOpSSlER0W3bdN93ba3pfd+2RvTeLeecNaWkHuyv66rHcTx1aKGw1mog4IwBohnIfozxmf8Xy3VdBuFEd0t2oMcv0B39yhwCcRBwMnLXwBlzZWv8HsK4lGa51jZqBpAiYDTMTt0h6675DWkW6ZousVyHHiAghzkQ/b1yV56H5nu4ygOEQhw3qpiZgA6YP8WB86fknAyWctN3qJZDFIMBFWm6ePPs0vMMJPPeMSY939H0egU9zzjgzIMZ+QAZunYTAwhY0gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Histograma de uma imagem 5 por 5\"\n        title=\"Histograma de uma imagem 5 por 5\"\n        src=\"/static/f9155045736f3768e65aa1888839aed3/1d69c/image-histogram.png\"\n        srcset=\"/static/f9155045736f3768e65aa1888839aed3/4dcb9/image-histogram.png 188w,\n/static/f9155045736f3768e65aa1888839aed3/5ff7e/image-histogram.png 375w,\n/static/f9155045736f3768e65aa1888839aed3/1d69c/image-histogram.png 750w,\n/static/f9155045736f3768e65aa1888839aed3/78797/image-histogram.png 1125w,\n/static/f9155045736f3768e65aa1888839aed3/aa440/image-histogram.png 1500w,\n/static/f9155045736f3768e65aa1888839aed3/b8bf8/image-histogram.png 1728w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Mas o número de partições não precisa ser idêntico à quantidade de valores na faixa de intensidades e o tamanho de cada partição não é necessariamente uniforme. No imagem anterior, nós poderiamos agrupar os valores em 5 partições ao invés de 10, o que nós iria dar as faixas: [0, 2), [2, 4), [4, 6),  [6, 8), [8, 10).</p>\n<p>A função que o OpenCV nos dá para obter um histograma de uma imagem é <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#ga4b2b5fd75503ff9e6844cc4dcdaed35d\">cv::calcHist()</a> e ela possua uma API razoavelmente complicada devido à tentativa de fornecer uma função genérica que se adapta a uma ou várias imagens com quantidades diferentes de canais e partições de intensidades não-uniformes ou uniformes. Nós iremos utilizá-la para uma única imagem de cada vez, então nós precisamos adaptar esta imagem para o que é esperado pela API (i.e. um vetor de imagens).</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">cv<span class=\"token operator\">::</span><span class=\"token function\">calcHist</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">const</span> cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">*</span> images<span class=\"token punctuation\">,</span>      <span class=\"token comment\">// Array de imagens estilo C  </span>\n\t<span class=\"token keyword\">int</span> nimages<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// Números de imagens no array images </span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> nchannels<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// Número de canais em cada imagem </span>\n\tInputArray mask<span class=\"token punctuation\">,</span>            <span class=\"token comment\">// Quais pixels serão levados em consideração </span>\n\tOutputArray hist<span class=\"token punctuation\">,</span>           <span class=\"token comment\">// O histograma resultante da imagem </span>\n\t<span class=\"token keyword\">int</span> dims<span class=\"token punctuation\">,</span>                   <span class=\"token comment\">// O número de dimensões do histograma</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span><span class=\"token operator\">*</span> histSize<span class=\"token punctuation\">,</span>        <span class=\"token comment\">// A quantidade de partições para cada dimensão</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> ranges<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// O tamanho de cada partição </span>\n\t<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// As partições são uniformes? (mesmo tamanho)</span>\n\t<span class=\"token keyword\">bool</span> accumulate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>     <span class=\"token comment\">// Se for true, o histograma não será limpo antes da operação</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>Tem bastante conteúdo para absorver nessa API, então vamos discutir os parâmetros um por um:</p>\n<ul>\n<li><strong>image</strong> - O array com as imagens cujo histograma será calculado. As imagens devem ser do tipo inteiro 8 bits ou ponto flutuante de 32 bits. Todas as imagens devem ter as mesmas dimensões mas a variação no número de canais é permitida</li>\n<li><strong>nimages</strong> - Número de imagens no array <strong>image</strong>. Já que os arrays estilo C não possuem informação sobre seu tamanho, é necessário informá-lo por meio da API.</li>\n<li><strong>nchannels</strong> - Os canais de interesse na imagem. Os canais são enumerados como se eles estivessem planificados (flattened) em um únicod array com todos os canais da image, logo se nós estamos interessados no primeiro e segunda canal da primeira imagem e no segundo canal da segunda imagem, nós necessitariamos de um vetor <strong>nchannels</strong> = { 0, 1, 4 }. Um ponteiro nulo <em>nullptr</em> pode ser passado caso uma unica imagem com um único canal será processada.</li>\n<li><strong>mask</strong> - Uma máscara com elementos de 8 bits que seleciona quais pixels serão levados em consideração. Apenas pixels da imagem cujo pixel correspondente na máscara é não-nulo serão contados. Se nós desejamos contar todos os pixels da imagem, <code class=\"language-text\">cv::noArray()</code> pode ser utilizado.</li>\n<li><strong>hist</strong> - O histograma resultante para todas as imagens.</li>\n<li><strong>dims</strong> - O número de dimensões do histograma. A função consegue lidar com dados com alta dimensionalidade caso queiramos agrupá-los em partições de várias dimensões. Por exemplo, se nós tivessemos uma imagem RGB em que queremos ver a frequência dos valores com uma determinada cor azul e vermelha, nós precisariamos de um histograma de 2 dimensões onde <code class=\"language-text\">hist.at&lt;float&gt;(i,j)</code> nos daria a frequência dos pixels com <strong>intensidade vermelha = i</strong> e <strong>intensidade azul = j</strong>.</li>\n<li><strong>histSize</strong> - Define a quantidade de partições utilizada em cada dimensão do histograma.</li>\n<li><strong>ranges</strong> - A faixa de valores do histograma. Esse parâmetro é utilizado para determinar a faixa de valores que serão alocadas em cada partição. A interpretação desse valor depende do valor do parâmetros <strong>uniform</strong>: Se o histograma é uniforme (<strong>uniform = true</strong>), é necessário apenas definir o valor máximo e mínimo da faixa, que será dividido uniformemente pela quantidade de partições. Se o histograma não for uniforme (<strong>uniforma = false</strong>), é preciso então definir as faixas de todas as partições explicitamente, ou seja, é necessário declarar um array com <strong>histSize[i] + 1</strong> elementos.</li>\n<li><strong>uniform</strong> - Se o histograma for uniforme todas as partições terão o mesmo tamanho.</li>\n<li><strong>accumulate</strong> - Se os valores que já estão em <strong>hist</strong> serão substituídos ou não durante a operação.\nDefinir <strong>accumulate</strong> como true permite ao usuário obter um histograma acumulado entre diversas chamadas de <code class=\"language-text\">cv::calcHist()</code> dado que a mesma variável seja fornecida para o parâmetro <strong>hist</strong>.</li>\n</ul>\n<p>Já que o parâmetro <strong>ranges</strong> é razoavelmente complicado, ele merece um pouco mais de explicação. Vamos ver alguns exemplos de como nós podemos especificar faixas para o exemplo de histograma mostrado na imagem anterior que possui uma faixa de intensidades entre [0, 10).</p>\n<p>Se nós queremos que nossas partições sejam uniformes com 2 elementos cada, nós podemos definir a configuraçãos como:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Isso irá dividir a faixa de valores [0, 10) e dividi-la igualemente em 5 partições.</p>\n<p>Se nós quisermos separar as intensidades em 4 partições não uniformes com faixas [0, 2), [2,5), [5, 8) and [8, 10), devemos especificar os parâmetros dessa forma:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Onde é possível notar que a faixa de valores para a partição <em>i</em> é dado pelos valores de <em>ranges[i]</em> e <em>ranges[i+1]</em>. Além disso precisamos especificar histSize[i] + 1 elementos para definir o histograma.</p>\n<p>Se nós tivermos uma imagem no espaço de cor HSV onde cada canal possui uma faixa de valores diferente, nós precisaremos definir um array diferente para cada canal.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>histSize <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>ranges<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">360</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// Faixa de valores para o canal de matiz (hue)</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// Faixa de valores para o canal de saturação  (saturation)</span>\n\t<span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// Faixa de valores para o canal de valor (value) </span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dims <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Estes parâmetros iriam resultar em um histograma tridimensional com o canal de matiz dividido em 60 partições e os canais de saturação e valor teriam ambos 20 partições.</p>\n<p>É importante notar que o array <strong>images</strong> não é utilizado para gerar histogramas para várias imagens de uma única vez, é apenas um mecanismo de seleção de canais: nós podemos passar duas imagens com um único canal em tons de cinza e selecionar ambos os canais com <strong>nchannels</strong>, mas isso não irá gerar dois histogramas separados, ao invés disso a função irá gerar um histograma único com duas dimensões onde cada partição é um membro do produto cartesiano entre as partições da primeira e segunda imagem, ou seja, haverá uma partição para cada conjunto (i, j), onde i é um valor de intensidade pertencente a primeira imagem, e j é um valor de intensidade pertencente a segunda.</p>\n<h2 id=\"utilizando-histogramas-em-processamento-de-imagens-equalização-de-histogramas\" style=\"position:relative;\"><a href=\"#utilizando-histogramas-em-processamento-de-imagens-equaliza%C3%A7%C3%A3o-de-histogramas\" aria-label=\"utilizando histogramas em processamento de imagens equalização de histogramas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Utilizando histogramas em processamento de imagens: equalização de histogramas</h2>\n<p>Agora que nós temos uma ideia básica de como criar histogramas no OpenCV, vamos ver como nós podemos utilizá-los em prática. Um dos efeitos mais simples que nós podemos obter utilizando a manipulação de histogramas é melhorar o constraste da imagem atráves de equalização de histograma. Essa técnica busca mapear as intensidades dos pixels de uma imagem de forma que o histograma resultante possua uma distribuição uniforme sobre toda a faixa de valores de intensidade. Esse processo é ilustrado abaixo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.17021276595745%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAAy0lEQVQoz21Riw7EIAjz//91y3LqHAhyFvfwliNrJqGWgiHnbK01Q8QYbdu2O8f/AkJELKXkOc7rutqyLA4ick6otXrRL6ga8lnwHXpy/gX4AYec2Q7Sn8IsqmhyikAQOJkTRgQkn0iWsnSHs6M2qF2I+2gVq2D2KfLOVg7tkBt7EavSHcJBTGTEII4C8HdsuO2CXMXQW7U5wMF9TBlA2As/O/KFNxdHx/cKnh3OD9aMGY7rcCgyHuaCqriL4o3a+CbHM/fi184nYvsC9I0pAfJsIzQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"An histogram being equalized\"\n        title=\"An histogram being equalized\"\n        src=\"/static/8fd6c0cf7b82b97697cfb75496e8e97b/1d69c/histogram-equalization.png\"\n        srcset=\"/static/8fd6c0cf7b82b97697cfb75496e8e97b/4dcb9/histogram-equalization.png 188w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/5ff7e/histogram-equalization.png 375w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/1d69c/histogram-equalization.png 750w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/78797/histogram-equalization.png 1125w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/aa440/histogram-equalization.png 1500w,\n/static/8fd6c0cf7b82b97697cfb75496e8e97b/2adcb/histogram-equalization.png 1984w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Se o histograma fosse contínuo, a equalização levaria à uma distribuição resultante perfeitamente uniforme, mas como os histogramas obtidos de imagens são discretos, a equalização resulta em uma aproximação da distribuição uniforme.</p>\n<p>A equalização discreta do histograma é definida pela seguinte equação:</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>k</mi></msub><mo>=</mo><mfrac><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow><mrow><mi>M</mi><mi>N</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>k</mi></munderover><mi>h</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy=\"false\">[</mo><mi>j</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">  out_{k} = \\frac{L-1}{MN}\\sum_{j=0}^{k}hist[j] </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.2498900000000006em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8361130000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">]</span></span></span></span></span>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>k</mi><mo>=</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>3</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi>L</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">  k = 0, 1, 2, 3, ... L - 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span>\n<p>Onde um pixel de intensidade <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> na imagem de origem seria mapeado para uma intensidade <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>k</mi></msub></mrow><annotation encoding=\"application/x-tex\">out_{k}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi></mrow><annotation encoding=\"application/x-tex\">M</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span></span></span></span> e <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> são as dimensões da imagem e <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> é o valor máximo da faixa de intensidades. Já que o resultado pode ser um valor fracionário, as intensidades são arredondadas para o inteiro mais próximo.</p>\n<p>Ao espalhar as intensidades dos pixels sobre toda a faixa de intensidades, os pixels são mapeados de forma que o contraste entre padrões da imagem é melhorado. Isto pode ser utilizado para recuperar detalhes em uma imagem desbotada, por exemplo</p>\n<p>Esta operação é implementada por meio da função <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#ga7e54091f0c937d49bf84152a16f76d6e\">cv::equalizeHist()</a> do OpenCV. Vamos ver como podemos usá-la para processar um stream de vídeo.</p>\n<h3 id=\"obtendo-o-stream-de-video\" style=\"position:relative;\"><a href=\"#obtendo-o-stream-de-video\" aria-label=\"obtendo o stream de video permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Obtendo o stream de video</h3>\n<p>O stream de video pode ser obtido utilizando a classe <a href=\"https://docs.opencv.org/4.4.0/d8/dfe/classcv_1_1VideoCapture.html\">cv::VideoCapture</a>. Ela funciona tanto para videos gravados ao especificar o caminho no sistema de arquivo onde eles estão armazenados, como para o feed de uma câmera em tempo real ao especificar seu ID.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string file_path<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_width<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_height<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nConfig <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">/* processar paramertos da linha de comando */</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>VideoCapture cap<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        cap<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cap<span class=\"token punctuation\">.</span><span class=\"token function\">isOpened</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Não foi possivel abrir a câmera/video.\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Define o tamanho do quadro a ser capturado</span>\n    cap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_WIDTH<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_HEIGHT<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Os valores de altura e largura podem não estar disponíveis</span>\n    <span class=\"token keyword\">int</span> width <span class=\"token operator\">=</span> cap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_WIDTH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> cap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>CAP_PROP_FRAME_HEIGHT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Nós precisamos especificar a altura e a largura dos quadros do video, mas nem todos os tamanhos são suportados, então nós precisamos checar também qual o valor que foi realmente selecionado.</p>\n<h3 id=\"lendo-quadros\" style=\"position:relative;\"><a href=\"#lendo-quadros\" aria-label=\"lendo quadros permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lendo quadros</h3>\n<p>Agora nós precisamos ler os quadros do video e aplicar a equalização de histograma em cada um.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* Obtendo o stream de video */</span>\n\n    cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap <span class=\"token operator\">>></span> image<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            std<span class=\"token operator\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Nao foi possivel ler quadros do video.\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// --- equalização do histograma ---</span>\n        <span class=\"token keyword\">auto</span> equalizedImage <span class=\"token operator\">=</span> <span class=\"token function\">equalize_rgb</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token keyword\">auto</span> equalizedLabImage <span class=\"token operator\">=</span> <span class=\"token function\">equalize_cie_lab</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"equalized rgb\"</span><span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"equalized cie lab\"</span><span class=\"token punctuation\">,</span> equalizedLabImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> ESCAPE_KEY<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Duas equalizações diferentes estão sendo aplicadas aqui, uma diretamente nos canais RGB da imagem e outra que primeiramente modifica a imagem do espaço RGB para o espaço CIE Lab e só então aplica a equalização.</p>\n<p>É necessário apenas fazer uma única equalização, nós fizemos duas equalizações diferentes aqui para que possamos comparar o efeito de cada uma na imagem original.</p>\n<h3 id=\"definindo-a-equalização\" style=\"position:relative;\"><a href=\"#definindo-a-equaliza%C3%A7%C3%A3o\" aria-label=\"definindo a equalização permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Definindo a equalização</h3>\n<p>A equalização do histograma de uma imagem RGB é feita por meio da equalização de cada canal individualmente, isso pode gerar artefatos visuais indesejados na imagem: já que a informação de cor em uma imagem RGB é completa apenas quando os três canais são combinados, equalizar os canais individualmente pode introduzir novas cores na imagem devido aos mapeamentos diferentes que ocorrem em cada canal. Uma equalização correta teria que mapear os três canais de forma idêntica.</p>\n<p>Já que o que nós queremos é aumentar o constrate de intensidade da imagem ao invés de manipular suas cores, nós podemos modificar a representação para um espaço de cor onde a intensidade é expressada separadamente.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/*\n * Equalização feita em canais individuais RGB\n */</span>\ncv<span class=\"token operator\">::</span>Mat <span class=\"token function\">equalize_rgb</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> <span class=\"token function\">equalizedChannels</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span><span class=\"token function\">Mat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedChannels<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n    cv<span class=\"token operator\">::</span>Mat equalizedImage<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>equalizedChannels<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> equalizedImage<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\ncv<span class=\"token operator\">::</span>Mat <span class=\"token function\">equalize_cie_lab</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat image<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> result_planes<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat lab_image<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span><span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> lab_image<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>COLOR_RGB2Lab<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>lab_image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat equalizedLuminosity<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">equalizeHist</span><span class=\"token punctuation\">(</span>planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> equalizedLuminosity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    result_planes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        equalizedLuminosity<span class=\"token punctuation\">,</span>\n        planes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        planes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat equalizedLabImage<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>result_planes<span class=\"token punctuation\">,</span> equalizedLabImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span><span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>equalizedLabImage<span class=\"token punctuation\">,</span> equalizedImage<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>COLOR_Lab2RGB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> equalizedImage<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* Obter o stream de video */</span>\n    <span class=\"token comment\">/* Ler os quadros */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>O <a href=\"https://en.wikipedia.org/wiki/CIELAB_color_space\">espaço de cor CIE Lab</a> possui um canal separado que representa a intensidade da luz, nós podemos então aplicar a equalização nesse único canal e então converter a imagem de volta para RGB.</p>\n<p>Com isso, nós podemos executar o binário e observar os resultados:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./build/equal_hist -i ~/Videos/the-wacky-wabbit.mp4</code></pre></div>\n<br/>\n<p>Com o frame não equalizado sendo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8AGmVqmaTpnWdqoCjq6NyZLRsT7ZyVZhNRJNEP3d2g3uswK7BwbjHxbfLzKq/w560vJGuvXenxHGnx3StzABvnq53pq+UuLantqi8iGSsblK1c1Oxdl2kY0+Cam+FssG0xMS2xcCwvLmtwsWiusGHrbx2qcJ2qcR1rsoAfZGilH2ThoWUjp6T0rFtrH5ZpGNOu31frHJXlGBWgJOeocjOrpyapYmHpMTIjK+5fqy/fa7BfK/Ff7PJALdggLdBda1adbaWdNGtbrePYZ5oUbuCV658XZVaRqSJgK/Iw66CdJpxboCsun+tuoGuvYWxwYa2xI67ywCqSXOBR22MVWi4WHLDZnnTqHTKpGbLoF6uf1qXXEqWdm2piHy7dFmqcGSZt72Zwsyawcmaw8iexsujydAAd2VqZUJjdzxYrUd6ViRDrV9v0aB5z61uwJVosoNbn2NXqVxRuG1VuXRapJ+Loq+VpaZ+o6+ln77BoMDBAIx6cUsZRG84T4RLYUg5QGktT8ybfsR/hMyBfsmFdLVVfqpKV7GDW5WVVp2bTq2US6SrVq+kha6lpb67rwCzo4tfVEiEb0yyn2J7aEmQUWy0dnqIOm2WWmCTW2GRRnHIkW3GsHNnjEyDnVGdqVmUs1q0t4DCrqDCuacA0MKgqJZrinNHnJBZfW9GjjxhuGl/wqx2fnFFtJpizrBy17x00bh3e5NPa4hCnrtjnbVhrqdwvoFuwqmTAMSwhMeyeopxSpOFVl9ZOmhYQY50VJaLVZuVXtSvc9Gzd9fEftS/d6emaqSgbLKOYLaKZcGec82bbMOYcgC0o3Orl2eEZkhvXz55b0mLek55ZTyif0/axH3XwH3Fk2raxIXbzILNvHzZwIjMjWzNgWbYwYTfzYrYwX8A4MiKzbx+1syMfHBLRT0haWA7iGdDum9KtXNSx5pizKdwwpVnvqBru7t1cWxDSDoyTF42oKdq5M2S2MCKANTGjsu+is67hK6QYyEZEBkeE1AsHGkaF4IzMaRUI6NNL20lHYI6KlpSNjAwHQAUDwo9J05VOLJ8WItbQgCSbE5wOC5kHxh2LCVjJiQhCAkbCgdzJSBpGheYQiB9IhdyHSAzEQkxGxY1GhMBEgsSOyosKBptGwlSDghsIK+YPQ1MgwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with no equalization\"\n        title=\"The Wacky Wabbit intro with no equalization\"\n        src=\"/static/446b9c750178e61ffe645c7fc1b4ec8a/1d69c/normal-wabbit.png\"\n        srcset=\"/static/446b9c750178e61ffe645c7fc1b4ec8a/4dcb9/normal-wabbit.png 188w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/5ff7e/normal-wabbit.png 375w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/1d69c/normal-wabbit.png 750w,\n/static/446b9c750178e61ffe645c7fc1b4ec8a/00d43/normal-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Nós temos a seguinte equalização RGB resultante:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8ACZ2wiRzvTmFwUiQwoFUW6BOO6VVQWQxKloqIjZYhz6Z3pTW5Kvo6qjx9ovP5nCt2Vif2TWL6C6M8DGc+AAsgMY1jMhjt8+Ftb2xa1uPUT6jVT+bWU98RThETGlMqOCg3+qm4+KXztmR1+p3v+NLm9g2j+M2keozofUAQXS6ZmCmT2ilXoCj1qBsi2VIfkM1sWFTjVVFXkFEQ3WufNv1k6OqgH2OfdLrU6PTQJndP53iPaHrQKz1AKRDjaYoepM9e6R/d9eebaR6VnBKO69lRZRhUWE5K3+AgZfa5JNqdGxTaT6Z0kGb00Kh2Uan4Emz61TD9gCTMXpeNm5oQGakP3a7S4HZnHbJkWDKhVKSZEplOy9hY2SKdX2wU0uLVFprvtxq0/Fr0+5s2PBx4fZ77fwAUk91NzZgUixSki6CNxQ9oEZ105V/1J9tt39jm2lMcUVFhz88qFBCqFlLfpaVerGkgaaDfrW6dMriddDjAG1hfxQNM0ssSWI/XScxNUkXTMmTh8Bqk81qh8dudqI5iI0qR5hwTnKJUXSPQJCEPn+qSpSXjZKTvrHFxgCqlqA9P0dzaU20pmdsY0lzN3KgX4FYJmx6SF50Sl9nOHHHhGu+q3Q8gUVVk0ZunEtgrk2fuIi7obm6v78A0Mm7opd3e21JlZxfbWZHcyJipVeHw7x+aWZGrJJg1bF058B407t6ToZHOnk3bbpXcrlak6l0s2Juuq+hAMq/mdTMi3hoS4iNXE1SOlRXQ35zVouPXJOjZdiuddm2fuTeid3QfJKkbJajdJqFW6Z2X7uQeNWaa72KcgC7uoOnm3FvWkhYWj5wd0+EfVJtWzyabEns4Ibo1obDgGXr3ZXt75DPzIXm05jKhXHLa2Dl0JH28J3p1o0A8+CbzMKI3uaed3RRLDAcV1g4e1pAqFo+olxGyJdj0KFzw4dqtZ5toL11WWJAPiUqK0AjmbBw9+Gn4sWZAOPopNPcntHUlaubbQ4PDA0XEDYnGzISEUkgJIM3F4U6JDwYFVMoHkFKNSApGwALCAAkFjJEL5h/YG1ZSQB6c1Y/MiorGBQ+Hxs4GBYKAwYHBQRJFxMzEA5xKxVKFQ02EhMWCQYfDw4fEAsACwgIJhwMFhAwCwEpBwME0Y9csW+2RwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with RGB equalization\"\n        title=\"The Wacky Wabbit intro with RGB equalization\"\n        src=\"/static/e9c91a266e9c8fe3caf3f9348b389125/1d69c/rgb-wabbit.png\"\n        srcset=\"/static/e9c91a266e9c8fe3caf3f9348b389125/4dcb9/rgb-wabbit.png 188w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/5ff7e/rgb-wabbit.png 375w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/1d69c/rgb-wabbit.png 750w,\n/static/e9c91a266e9c8fe3caf3f9348b389125/00d43/rgb-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Nesse caso, a equalização RGB está aceitável, mas ainda é possível notar que ela introduziu bordas rosas nas montanhas. Em outros frames a variação de cor resultante é bastante perceptível.</p>\n<p>Por fim, a equalização CIE Lab resultante:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.80851063829788%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQozwFWA6n8AEZxgkFtfVuCjWyOlXlNOIhFIIxNJWwnD2khDk9RWGybrtDi4+T08uf7/cXa36K4woqntmGQrF+UsnGqyQBPfIpdi5OXuripuKuVYzqBSCSKTCKIUTB5PCFYQ0KArLrc7e3f7+nM2dfP5OezzNN7obBlla5nmbNzrcgAW259bllsYWFua3pus5RNhFkvdjoblFk1gkwqZzgoXXB5wOjttqaik3t3vt/jhamzc6Czdqa5eqzChLjQAIw6VokXR4IzS5V2UrWRUZVwPnJBJJJdKodZNmQuE5d+cs3l4I5mVXFLRG+cqnOgrHuptoSxv4+/zqPR4QCCJktjLFBrNkiOMkiaQU+8klyrhkWmfTWGWjFoMRp6XVGPcmCNSiiBTDmox8y23+m13eW54+nE7fLP9/wAW0tPUC5NWiA7gh5PPQ0qiD5Lu4xjt5ZUoHdHi18zcjwpfDYgjEglj08tl5R9orGVnJ9zq7iutNPWutvcAG1bUzMBK1ghN2w0SjwtNEoQMLuNbaViZapkXKZlUIktUnofIZBmNHp7PHx7K4pzJ4yUPJqQcJyVlM7MwACklHxJPTF6Z0SzoWNwXj9rLkeRVldiFUZ5P0N3QUVzKlSwe1S1oGFRdDZngDN+ijZ7mT6qrXW3pJXMwrAA18imp5Rqf2k9opZgcWM6ZhY5mEtfy7V/b2I4pItRx6lr07hwybFuYHc0TWklhKBFiqFMo51lll1Gxa6WAM++kdzIj35lP5aKXFZSMmRUPoZuTZaKVqOeZ8mmaM2vcujVkNvGfZuaX6Cdapt7R5huRK2LX8GTYa2EXADEuomsl2dzVzhmWDV9d1GJek1sWDCHZjLt2I/mz4upekzu2Jj255zWxYTlz5W7gFmrZD7gzI737Kvj0Y8A8Nqayrh66OGifnNPNi4RXFUudVgxmVIiklUpu5BXv5piroJTtJdgs7RsYl41MiQZKTgNoapt8Nuh0r2FAO/lsOPZpd/Pl7KYahgRBhIYDEgnFlkOBmIZDHguAYMzEFgUBmQiCFBILCgoFgAMCAAiDjtAIq17VoNWPACTdFdlMCFZFQphGw5LFAgcAwIXBwJaEQFWCwB0JABkDwFdDQMpBwAiDQYnDgMADQcBJhQcFAlTBgBDBQAx9oCakQRmkwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The Wacky Wabbit intro with RGB equalization\"\n        title=\"The Wacky Wabbit intro with RGB equalization\"\n        src=\"/static/190555c8f5ae762b83ce5b5dde99de01/1d69c/cielab-wabbit.png\"\n        srcset=\"/static/190555c8f5ae762b83ce5b5dde99de01/4dcb9/cielab-wabbit.png 188w,\n/static/190555c8f5ae762b83ce5b5dde99de01/5ff7e/cielab-wabbit.png 375w,\n/static/190555c8f5ae762b83ce5b5dde99de01/1d69c/cielab-wabbit.png 750w,\n/static/190555c8f5ae762b83ce5b5dde99de01/00d43/cielab-wabbit.png 1000w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Nós podemos notar que a equalização fez com que a imagem original se tornasse mais escura e o constraste entre os cactus e nuvens são mais aparentes.</p>\n<h2 id=\"implementando-o-detector-de-movimentos\" style=\"position:relative;\"><a href=\"#implementando-o-detector-de-movimentos\" aria-label=\"implementando o detector de movimentos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementando o detector de movimentos</h2>\n<p>Depois de falar sobre histogramas por um bom tempo, nós podemos finalmente iniciar o desenvolvimento donosso detector de movimentos. A ideia por trás da implementação de um detector de movimentos utilizando histogramas envolve a comparação dos histrogramas de frames subsequentes, checando se o movimento do objeto introduziu mudanças na frequência das intensidades.</p>\n<p>Nosso detector de movimentos irá mostrar um texto de alarme na tela caso ele detecte qualquer objeto em movimento para que possamos checar se está funcionando corretamente.</p>\n<p>Para implementar a comparação de histogramas, nós precisamos armazenar tanto o frame atual quanto o anterior para que possamos compará-los. Eu decidi utilizar um std::deque para isso pois eu acredito que o problema se encaixa bem na ideia de janelas móveis, mas deve haver uma implementação mais simples que apenas armazena o frame anterior.</p>\n<p>Baseado nisso, nós chegamos na seguinte implementação:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/**\n * Calcula um escore de similaridade entre dois histogramas subsequentes\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HistogramSimilarity</span> <span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>deque<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> window <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> _score <span class=\"token operator\">=</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// 1.0 é o escore para histogramas idênticos </span>\n\n    <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat current_histogram<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Se há apenas um unico frame, nós armazenamos o atual</span>\n            <span class=\"token comment\">// e calculamos o escore de similaridade</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">auto</span> previous <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">,</span> current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// Se houverem dois frames, nós descartamos o</span>\n            <span class=\"token comment\">// mais antigo para dar espaço para o atual</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                window<span class=\"token punctuation\">.</span><span class=\"token function\">pop_back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">auto</span> previous <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>previous<span class=\"token punctuation\">,</span> current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// Se não houver nenhum frame armazenado, nós não podemos</span>\n            <span class=\"token comment\">// calcular o escore ainda</span>\n            window<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>current_histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>_score<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">float</span> <span class=\"token function\">calc_score</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat hist1<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>Mat hist2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> cv<span class=\"token operator\">::</span><span class=\"token function\">compareHist</span><span class=\"token punctuation\">(</span>hist1<span class=\"token punctuation\">,</span> hist2<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>HISTCMP_CORREL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Nós temos um único método push que receberá os frames e calculará os escores por demanda. Existem três estados possíveis para a nossa janela móvel:</p>\n<ul>\n<li>A janela está vazia, o que significa que nenhum frame foi consumido ainda. Nós não podemos calcular a similaridade, então nós apenas armazenamos o frame atual e esperamos pelo próximo.</li>\n<li>A janela possui um frame. Nesse caso nós calculamos a similaridade e armazenamos o frame atual para a próxima operação.</li>\n<li>A janela possui dois frames. Nesse caso, nós descartamos o frame mais antigo, calculamos o escore e armazenamos o frame atual.</li>\n</ul>\n<p>O escore é implementado por meio da função <a href=\"https://docs.opencv.org/4.4.0/d6/dc7/group__imgproc__hist.html#gaf4190090efa5c47cb367cf97a9a519bd\">cv::compareHist()</a> utilizando o metodo de comparação <code class=\"language-text\">cv::HISTCOMP_CORREL</code> que calcula a <a href=\"https://en.wikipedia.org/wiki/Correlation_and_dependence\">correlação estatística</a> entre os histogramas. Utilizando este método de comparação, a ausência de movimento seria representada por um escore igual a 1.0, enquanto um movimento iria levar o escore em direção a -1.0 dependendo do quão grande foi a variação introduzida na imagem.</p>\n<p>Com isso, nós temos um escore que nos permite implementar o detector de movimento ao checar se ele é maior que um limiar:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/**\n * Detecta movimentos baseado na similaridade entre\n * histogramas subsequente em um stream de imagens (camera ou video)\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MotionDetector</span> <span class=\"token punctuation\">{</span>\n    HistogramSimilarity similarity<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> threshold<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_qnt<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_count<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n        <span class=\"token function\">MotionDetector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> thres<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_frame_quantity<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n            similarity <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            threshold <span class=\"token punctuation\">{</span> thres <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            alarm_frame_qnt <span class=\"token punctuation\">{</span> alarm_frame_quantity <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            alarm_frame_count <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>cv<span class=\"token operator\">::</span>Mat histogram<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                alarm_frame_count<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            similarity<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>histogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">motion_detected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                alarm_frame_count <span class=\"token operator\">=</span> alarm_frame_qnt<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> similarity<span class=\"token punctuation\">.</span><span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">bool</span> <span class=\"token function\">motion_detected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> similarity<span class=\"token punctuation\">.</span><span class=\"token function\">score</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> threshold<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">float</span> <span class=\"token function\">alarm_counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> alarm_frame_count<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">bool</span> <span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> alarm_frame_count <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>O detector de movimentos delega os frames para a classe <code class=\"language-text\">HistogramSimilarity</code> e checa se o escore resultante é maior que o limiar. Se nós tentarmos mostrar o alarme na tela, ele será apagado assim que o próximo frame for desenhado. Isto acontece tão rápido que talvez nem seja possível observar o alerta na tela, então nós criamos um contador de frames que irá definir por quantos frames o texto de alarme será mostrado.</p>\n<p>Por fim, nós colocamos isso em prática ao abrir um arquivo de video e lendo seu conteúdo. Nós podemos obter o stream de video da mesma forma que fizemos para o <a href=\"#obtendo-o-stream-de-video\">exemplo de equalização</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string file_path<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_width<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> screen_height<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span> threshold<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> alarm_qnt_frame<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nConfig <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* parse cli arguments */</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> config <span class=\"token operator\">=</span> <span class=\"token function\">parse_cli</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* Obter o stream de video */</span>\n\n    <span class=\"token comment\">// ----- Configurando o stream de video -----</span>\n\n    <span class=\"token comment\">// Histograma para um dos canais da imagem</span>\n    cv<span class=\"token operator\">::</span>Mat histR<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Quantidade de partições on as intensidades dos pixels serão alocadas</span>\n    <span class=\"token keyword\">int</span> nbins <span class=\"token operator\">=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Os limites da faixa de valores do histograma</span>\n    <span class=\"token keyword\">float</span> range<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>histrange <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> range <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// As partições do histograma são uniformes</span>\n    <span class=\"token keyword\">bool</span> uniform <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Acumular o resultado com os valores atuais do histograma</span>\n    <span class=\"token keyword\">bool</span> accumulate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Armazena os canais BGR separados (i.e. planes[] é o canal vermelho)</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>cv<span class=\"token operator\">::</span>Mat<span class=\"token operator\">></span> planes<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat resized_image<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point screen_size <span class=\"token punctuation\">{</span> config<span class=\"token punctuation\">.</span>screen_width<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>screen_height <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    MotionDetector <span class=\"token function\">detector</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>threshold<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>alarm_qnt_frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cap <span class=\"token operator\">>></span> image<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            std<span class=\"token operator\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not read frame from video, possibly due to wrong screen dimensions.\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token operator\">::</span>endl<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">,</span> screen_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//  Divide os canais individuais da imagem</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>resized_image<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">auto</span> blue_channel <span class=\"token operator\">=</span> planes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Obtem o histograma do canal azul</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">calcHist</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span>blue_channel<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">noArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            histB<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>nbins<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>histrange<span class=\"token punctuation\">,</span>\n            uniform<span class=\"token punctuation\">,</span> \n            accumulate\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Nós passamos o histograma para o detector</span>\n        detector<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>histB<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Se o alarme está ativo, escrevemos uma mensagem na tela</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>detector<span class=\"token punctuation\">.</span><span class=\"token function\">alarm_active</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            cv<span class=\"token operator\">::</span>Point2i top_left <span class=\"token punctuation\">{</span> resized_image<span class=\"token punctuation\">.</span>rows <span class=\"token operator\">/</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">.</span>cols <span class=\"token operator\">/</span> <span class=\"token number\">20</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">putText</span><span class=\"token punctuation\">(</span>\n                resized_image<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Motion Detected\"</span><span class=\"token punctuation\">,</span>\n                top_left<span class=\"token punctuation\">,</span>\n                cv<span class=\"token operator\">::</span>FONT_HERSHEY_PLAIN<span class=\"token punctuation\">,</span>\n                <span class=\"token number\">1.2</span><span class=\"token punctuation\">,</span>\n                <span class=\"token function\">CV_RGB</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">}</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> resized_image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> ESCAPE_KEY<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>Eu testei esta implementação nesse <a href=\"https://www.pexels.com/video/a-railway-under-a-flyover-3250590/\">video do pexels</a> que mostra um trem se movendo embaixo de uma ponte. Com a escolha apropiada do limiar de detecção, o detector conseguiu detectar o trem se movendo razoavelmente bem.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=edujtm data-host=localhost></span></span>./build/apps/motion_detector -i ~/Videos/train-bridge.mp4  --width <span class=\"token number\">480</span> --height <span class=\"token number\">320</span> -t <span class=\"token number\">0.9972</span></code></pre></div>\n<br/>\n<p>Alguns exemplos do detector de movimentos podem ser vistos abaixo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADIUlEQVQozw2MXWgbBQCA71FGVexas1zTtEmaXJrc/yV3vdx/7/J3l+Ty2ybtpe0lqfZnSTNwnQwG+8Ot/qBuDNlYBR/UPsgeCg7BB0H20EdhbGygTNh0KGywzTF0PzFP3/fyfYCCO2OTb8vIAQU9wEJDcniI9Q9y0DDjGdi5+Mmj+3e782ll8k0eGlw10TMHNRVzKSioEaNTgWEgToxIYUeCGJnlx1IkqGHOODqshB1R92tfnOz+9+DukSWD8+6bV/wftRNF3qeiDmFyMEGA/QWQjLjj+EiZdS+I4ILo6osRcekkKPj2nT1sv3r+zzs5Rkf3f7Ci1hRIgN7gAwNlFVstixoGAirhThGuK9sff//1+SOWsiCMZrFBM+LMkkP1BHrvzu0ZKdgt4nXFJ0OvL+fZr86fuvfr9as7l7NRNyAhoJ2hnzz8u9frPX384JdrP3y59d5GKTrHu7jAwPaFDw8tpS1l/PDi9E9XLjz580bv2f1/H/72+/WfV4oMwAbe+ux4p1++fP6013vR54tnjx/9dee7y1sl2W8XhUZRErDRvR+//ePWtas7l27v7d7a2725t3uiXQJE2LnZzHxz8ei5M+9uf77x6XHrWMe8tLV27tjyWlXcbCmtEmWqoaKBy0JU1zirEm9U1W4j2a5xgDE1YefJWR2a0SdrOtIsYWtz+MY8sj4bblWwth1s1oLFVNCaGWdp0OMFvT5nYALEwmMZMQSYQvBU2zjZTpzYkE53pdMd7miL2lzCO3W4WYHsqq+W91Sz3vmydybn04RxDHeMju93OIcIeAyoaGTHSi8XYo18tG6Qlo7PJYmSHMoIEwYfSHOQRnv1mF+JejjSw5N+CvaGAu4Q5MFhL1CeJq3sdEljCwqTFSmdJ9MxPM5gcRrVoogaReUIIlKwRCEyjSs0ITOkSBMCQwg0AVRUzDbYRoa1DcZKRqrTVEnCTB4xOaQvOQ42+XBBQHM8kuPh9BScZtEMT6Y4Ks1RwEohdnYl8/5C8lBNPViWVvPcshlr5mJ2JtafLqXoxQRpJ6nFVKSejFgpppkV1gtCK8uuV+T/AZKSAsXMvnoQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imagem de uma ponte com trilhos de trêm embaixo\"\n        title=\"Imagem de uma ponte com trilhos de trêm embaixo\"\n        src=\"/static/aa90b1fa4d7825a0f1c0165584cb1a42/e85cb/no-detection.png\"\n        srcset=\"/static/aa90b1fa4d7825a0f1c0165584cb1a42/4dcb9/no-detection.png 188w,\n/static/aa90b1fa4d7825a0f1c0165584cb1a42/5ff7e/no-detection.png 375w,\n/static/aa90b1fa4d7825a0f1c0165584cb1a42/e85cb/no-detection.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>O detector é capaz de ver o trem atravessando os trilhos:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADIUlEQVQozw3NX0wbdQDA8YtxmzNx9Fp6pdyf3t/eXX+9X3u9a6/XFgrt0ZaWtZTyXzZmFxKqI4AvojxsYQsZL/uTKSaO6ZIZjX+W+Wjc5gObQZYs/iX6xl6mbyQaZbjBTpLP8/eLJPzuo6GWmuZJCS6dRBMsquGvhIkm3nlgopb/eX115eJZnW6C+JG44Jp7TR/NSZB2QsoByCbECjaXNXc1hlcNIqN4YrxLYxyqDxVdBxsDXY9++m5p7nXoPaQz6PRw+FghEPI5Vdrh97wktBxGPl1e+HDpzXpOLipoQXFmAWYKmMm7YOvLA53w78cb85PDovOFiXJwvBvs/yXsAPQ5aoXkxYW3kP+e/GPb9h+bv32xcmF6KNMTxpLM4ZTf2Saicd618eB2vS/brWJjlhjwHEwrxOzJ/s+vL6/fu/Pr93eQ3Wfbz3ef2PbefmJn+68f1m6/vzh7oqAUQs0i9uLi/BuzJys5FRvMgOWFxsO7n/35+9qjX+7/eP/r9W+/Qmx71957au/tPH/2r20/te2t3Z3NrcdrH195Ox3Cyx1wuJgQWo98cuXMxurNG8vn791aWb117e7Nq998+QHy0aV33jt36t3FyaX58ctnJ07PVE4d71yaG12YHuy34ImK1peVUiqVSQhRFZhRWLSMat441mse740jpSRb7RAsk+w0KMtgjqbZmsW9WmCHuuhyhzBS9tWKVDrmK1peBaAeD0pSXjfmIryoyLiRuXpmasRoDOlTY5GZUXVqRGkMSPUyP9rN9mapSr7VSrdkE625tDeb8uQ7Aooe5SRZkmUxEEAm+9pmxrKN/li9oo73hMZLoJLiepJ0MUXlTDJjEO2aNxvFU6pXVzz5mGRSlCHyMVmMSn6k1B6tWslOHRiAj0psDHCaxIY4KsRTQY6CPA1YSqaJAE1INCn6cBJrdqNoM4q6UQdSSsCSqRTioCsqZzQprYptIX8SCknI70sEORNwZpCLA9YArC4zEYkOSwwUWeBnkXbI77Mi/nbIpoKsGaRVnojwuMbjSYWJiWSYx3XZZwQYXSQjfkLytcgMHhEZwDP/A2KW7gn9/1adAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Image of the bridge with the train arriving at the railroad\"\n        title=\"Image of the bridge with the train arriving at the railroad\"\n        src=\"/static/4e17e3a054eb779fba34412cfde0727a/e85cb/train-arriving.png\"\n        srcset=\"/static/4e17e3a054eb779fba34412cfde0727a/4dcb9/train-arriving.png 188w,\n/static/4e17e3a054eb779fba34412cfde0727a/5ff7e/train-arriving.png 375w,\n/static/4e17e3a054eb779fba34412cfde0727a/e85cb/train-arriving.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><em>Creditos: imagens obtidas desse <a href=\"https://www.pexels.com/video/a-railway-under-a-flyover-3250590/\">video</a> filmado por <a href=\"https://www.pexels.com/@alexander-bobrov-390088?utm_content=attributionCopyText&#x26;utm_medium=referral&#x26;utm_source=pexels\">Alexander Bobrov</a>, disponível no <a href=\"https://www.pexels.com/\">Pexels</a></em></p>\n<p>Já que esse detector não é robusto, ele pode gerar detecções espúrias que provavelmente não são aceitáveis quando estamos desenvolvendo um alarme. Além disso, o sensor é bem sensível ao limiar de intensidade especificado: se dermos um valor muito baixo, é possível que o sensor não detecte nenhum movimento e, além disso, pequenos objetos podem não ser detectados já que não causam variações grandes na imagem. Então isto está longe de ser um detector ideal, mas é um bom exemplo de como pensar nas imagens em termos de seus histogramas.</p>\n<h2 id=\"conclusão\" style=\"position:relative;\"><a href=\"#conclus%C3%A3o\" aria-label=\"conclusão permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusão</h2>\n<p>As vezes pode ser útil pensar nas imagens em termos de seus histogramas, ao invés de um array de pixels. Com o histograma em mãos, nós podemos manipulá-lo e observar seus efeitos na imagem ou usá-lo em combinação com outras técnicas para obter o efeito desejado. OpenCV oferece diversas funções para gerar e manipular histogramas de imagens, espero que este artigo tenha mostrado como elas podem ser utilizadas em prática.</p>"}},"pageContext":{"slug":"opencv-motion-detector","lang":"pt","language":"pt","i18n":{"language":"pt","languages":["en","pt"],"defaultLanguage":"en","routed":true,"resources":{"pt":{"about":{"About me":"Sobre mim","my-description":"Eu sou um estudante de Engenharia da Computação na Universidade Federal do Rio Grande do Norte. Tenho interesse sobre tópicos relacionados a desenvolvimento mobile para Android, mas também possuo como hobby o estudo de tópicos sobre Aprendizagem de máquina e Sistemas Operacionais.","need-developer":"Precisa de um desenvolvedor?","contact-me":"Entre em contato comigo."},"bloglist":{"Blog":"Blog","blog-description":"Pequenos posts sobre tópicos de ciências da computação que eu achei interessante."},"contact":{"contact-info":"Informações de contato"},"footer":{"gatsby-credit":"Criado por {{creator}} usando","fireplace-icon":"Ícone de lareira","by":"por"},"header":{"Edu's coding fireplace":"Lareira de código do Edu","Home":"Home","Blog":"Blog","About":"Sobre","Contact":"Contato"},"home":{"hello":"Olá.","i-am":"Eu sou","my-place":"este é o lugar onde eu expresso meus pensamentos sobre assuntos que envolvem programação.","my-goal":"Espero poder compartilhar informações úteis para o mundo, da mesma forma que fizeram por mim."}}},"originalPath":"/blog/opencv-motion-detector","path":"/pt/blog/opencv-motion-detector"}}},"staticQueryHashes":["3159585216","3159585216","440568431"]}